{% extends 'base.html' %}
{% block title %}{{ title|default:'Add Student' }} | School Management System{% endblock %}
{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">{{ title|default:'Add Student' }}</h4>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="post" enctype="multipart/form-data" novalidate id="studentForm">
                        {% csrf_token %}
                        
                        <!-- Hidden container for term checkboxes (inside form so they submit) -->
                        {% if student and terms %}
                        <div id="transportTermsContainer" style="display: none;">
                            {% for term in terms %}
                            <input type="checkbox" 
                                   class="term-checkbox-hidden" 
                                   name="apply_transport_to_terms" 
                                   value="{{ term.id }}" 
                                   id="term_hidden_{{ term.id }}">
                            {% endfor %}
                        </div>
                        <div id="optionalFeeTermsContainer" style="display: none;">
                            {% for term in terms %}
                            <input type="checkbox" 
                                   class="optional-fee-term-checkbox-hidden" 
                                   name="apply_optional_fees_to_terms" 
                                   value="{{ term.id }}" 
                                   id="optional_fee_term_hidden_{{ term.id }}">
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- Display form errors at the top -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}
                        
                        <div class="row g-3">
                            <!-- Student ID (Auto-generated) -->
                            <div class="col-md-4">
                                <label class="form-label">Student ID</label>
                                <input type="text" class="form-control" value="Auto-generated" disabled>
                                <div class="form-text">Student ID will be auto-generated</div>
                            </div>
                            
                            <!-- NEMIS/UPI Number -->
                            <div class="col-md-4">
                                <label for="{{ form.upi.id_for_label }}" class="form-label">
                                    {{ form.upi.label }}
                                    {% if form.upi.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.upi }}
                                {% if form.upi.help_text %}
                                    <div class="form-text">{{ form.upi.help_text }}</div>
                                {% endif %}
                                {% if form.upi.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.upi.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- First Name -->
                            <div class="col-md-4">
                                <label for="{{ form.first_name.id_for_label }}" class="form-label">
                                    {{ form.first_name.label }}
                                    {% if form.first_name.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.first_name }}
                                {% if form.first_name.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.first_name.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Middle Name -->
                            <div class="col-md-4">
                                <label for="{{ form.middle_name.id_for_label }}" class="form-label">
                                    {{ form.middle_name.label }}
                                    {% if form.middle_name.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.middle_name }}
                                {% if form.middle_name.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.middle_name.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Last Name -->
                            <div class="col-md-4">
                                <label for="{{ form.last_name.id_for_label }}" class="form-label">
                                    {{ form.last_name.label }}
                                    {% if form.last_name.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.last_name }}
                                {% if form.last_name.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.last_name.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Gender -->
                            <div class="col-md-4">
                                <label for="{{ form.gender.id_for_label }}" class="form-label">
                                    {{ form.gender.label }}
                                    {% if form.gender.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.gender }}
                                {% if form.gender.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.gender.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Date of Birth -->
                            <div class="col-md-4">
                                <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">
                                    {{ form.date_of_birth.label }}
                                    {% if form.date_of_birth.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.date_of_birth }}
                                {% if form.date_of_birth.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.date_of_birth.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Grade -->
                            <div class="col-md-4">
                                <label for="{{ form.grade.id_for_label }}" class="form-label">
                                    {{ form.grade.label }}
                                    {% if form.grade.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.grade }}
                                {% if form.grade.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.grade.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- School Class -->
                            <div class="col-md-4">
                                <label for="{{ form.school_class.id_for_label }}" class="form-label">
                                    {{ form.school_class.label }}
                                    {% if form.school_class.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                <select name="{{ form.school_class.name }}" id="{{ form.school_class.id_for_label }}" class="form-select">
                                    <option value="">---------</option>
                                    {% for choice in form.school_class.field.queryset %}
                                        <option value="{{ choice.id }}" 
                                                data-grade-id="{{ choice.grade.id }}"
                                                data-teacher-name="{% if choice.class_teacher %}{{ choice.class_teacher.full_name }}{% endif %}"
                                                data-teacher-id="{% if choice.class_teacher %}{{ choice.class_teacher.id }}{% endif %}"
                                                {% if form.school_class.value == choice.id %}selected{% endif %}>
                                            {{ choice.name }} ({{ choice.grade.name }})
                                        </option>
                                    {% endfor %}
                                </select>
                                <div id="class_teacher_display" class="mt-2" style="display: none;">
                                    <small class="text-muted">
                                        <i class="fas fa-user-tie me-1"></i>
                                        <strong>Class Teacher:</strong> <span id="class_teacher_name"></span>
                                    </small>
                                </div>
                                {% if form.school_class.help_text %}
                                    <div class="form-text">{{ form.school_class.help_text }}</div>
                                {% endif %}
                                {% if form.school_class.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.school_class.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Admission Date -->
                            <div class="col-md-4">
                                <label for="{{ form.admission_date.id_for_label }}" class="form-label">
                                    {{ form.admission_date.label }}
                                    {% if form.admission_date.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.admission_date }}
                                {% if form.admission_date.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.admission_date.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Address -->
                            <div class="col-md-6">
                                <label for="{{ form.address.id_for_label }}" class="form-label">
                                    {{ form.address.label }}
                                    {% if form.address.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.address }}
                                {% if form.address.help_text %}
                                    <div class="form-text">{{ form.address.help_text }}</div>
                                {% endif %}
                                {% if form.address.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.address.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Transport Route -->
                            <div class="col-md-4">
                                <label for="{{ form.transport_route.id_for_label }}" class="form-label">
                                    {{ form.transport_route.label }}
                                    {% if form.transport_route.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                <select name="{{ form.transport_route.name }}" id="{{ form.transport_route.id_for_label }}" class="form-select">
                                    <option value="">None</option>
                                    {% for route in form.transport_route.field.queryset %}
                                        <option value="{{ route.id }}" 
                                                data-fare="{{ route.base_fare }}"
                                                {% if form.transport_route.value == route.id %}selected{% endif %}>
                                            {{ route.name }} (KES {{ route.base_fare|floatformat:2 }})
                                        </option>
                                    {% endfor %}
                                </select>
                                <div id="transport_route_info" class="mt-2" style="display: none;">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <strong>Route Fare:</strong> <span id="route_fare_display"></span>
                                    </small>
                                </div>
                                {% if form.transport_route.help_text %}
                                    <div class="form-text">{{ form.transport_route.help_text }}</div>
                                {% endif %}
                                {% if form.transport_route.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.transport_route.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Student Photo -->
                            <div class="col-md-6">
                                <label for="{{ form.photo.id_for_label }}" class="form-label">
                                    {{ form.photo.label }}
                                    {% if form.photo.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {% if student and student.photo %}
                                    <div class="mb-2">
                                        <img src="{{ student.photo.url }}" alt="Current photo" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                        <div class="form-text">Current photo</div>
                                    </div>
                                {% endif %}
                                {{ form.photo }}
                                {% if form.photo.help_text %}
                                    <div class="form-text">{{ form.photo.help_text }}</div>
                                {% endif %}
                                {% if form.photo.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.photo.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Optional Fee Categories -->
                            {% if form.optional_fee_categories.field.queryset %}
                            <div class="col-12">
                                <label class="form-label">Optional Fee Categories</label>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="row">
                                            {% for checkbox in form.optional_fee_categories %}
                                            <div class="col-md-6 mb-2">
                                                <div class="form-check">
                                                    {{ checkbox.tag }}
                                                    <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                                                        {{ checkbox.choice_label }}
                                                    </label>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <div class="form-text mt-2">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Select optional fee categories this student should pay. These fees will be applied when generating student fees.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Linked Parents/Guardians -->
                            <div class="col-12">
                                <label for="id_parents" class="form-label">
                                    Linked Parent/Guardian Accounts
                                </label>
                                <div class="multi-select-wrapper">
                                    <div class="selected-items mb-2" id="selected-parents">
                                        {% if student %}
                                            {% for parent in student.parents.all %}
                                                <span class="badge bg-primary me-1 mb-1" data-value="{{ parent.id }}">
                                                    {{ parent.full_name }} ({{ parent.user.username }})
                                                    <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.7em;" aria-label="Remove"></button>
                                                </span>
                                            {% endfor %}
                                        {% else %}
                                            {% for parent in form.parents.value %}
                                                {% for parent_obj in form.parents.field.queryset %}
                                                    {% if parent_obj.id|stringformat:"s" == parent|stringformat:"s" %}
                                                        <span class="badge bg-primary me-1 mb-1" data-value="{{ parent_obj.id }}">
                                                            {{ parent_obj.full_name }} ({{ parent_obj.user.username }})
                                                            <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.7em;" aria-label="Remove"></button>
                                                        </span>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="parentDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                            Select Parents/Guardians
                                        </button>
                                        <ul class="dropdown-menu w-100" aria-labelledby="parentDropdown" id="parentDropdownMenu">
                                            {% for parent in form.parents.field.queryset %}
                                                <li>
                                                    <a class="dropdown-item parent-item" href="#" data-value="{{ parent.id }}" data-text="{{ parent.full_name }} ({{ parent.user.username }})">
                                                        {{ parent.full_name }} ({{ parent.user.username }})
                                                        {% if parent.phone %}
                                                            - {{ parent.phone }}
                                                        {% endif %}
                                                    </a>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <input type="hidden" name="parents" id="id_parents" value="">
                                </div>
                                {% if form.parents.help_text %}
                                    <div class="form-text">{{ form.parents.help_text }}</div>
                                {% endif %}
                                {% if form.parents.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.parents.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'core:student_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> Back to Students
                                    </a>
                                    <button type="submit" class="btn btn-primary" id="submitStudentForm" {% if student %}disabled{% endif %}>
                                        <i class="fas fa-save"></i> {% if student %}Update{% else %}Create{% endif %} Student
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Transport Route Change -->
{% if student %}
<div class="modal fade" id="transportRouteModal" tabindex="-1" aria-labelledby="transportRouteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="transportRouteModalLabel">
                    <i class="fas fa-route me-2"></i>Transport Route Changed
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You have changed the transport route for this student. Do you want to apply this change to terms?</p>
                
                <div class="mb-3">
                    <div class="d-flex gap-4">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="transportApplyOption" id="transportApplyToTerms" value="apply" checked>
                            <label class="form-check-label" for="transportApplyToTerms">
                                <strong>Apply changes to terms</strong>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="transportApplyOption" id="transportDontApply" value="dont_apply">
                            <label class="form-check-label" for="transportDontApply">
                                <strong>Don't apply to terms</strong>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div id="transportTermsSelection" class="mb-3">
                    <label class="form-label">Select Terms:</label>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="selectAllTerms" checked>
                        <label class="form-check-label" for="selectAllTerms">
                            <strong>Select All</strong>
                        </label>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 10px;">
                        {% for term in terms %}
                        <div class="form-check">
                            <input class="form-check-input term-checkbox" type="checkbox" 
                                   value="{{ term.id }}" 
                                   id="term_{{ term.id }}"
                                   data-term-id="{{ term.id }}"
                                   checked>
                            <label class="form-check-label" for="term_{{ term.id }}">
                                {{ term.academic_year }} - Term {{ term.term_number }}
                                {% if term.is_active %}<span class="badge bg-success ms-2">Active</span>{% endif %}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="alert alert-info mt-2 mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>Transport fees will be updated (or removed if route is cleared) for the selected terms.</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmTransportChange">
                    <i class="fas fa-check me-2"></i>Apply Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal for Optional Fee Categories Change -->
{% if student %}
<div class="modal fade" id="optionalFeeModal" tabindex="-1" aria-labelledby="optionalFeeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-dark">
                <h5 class="modal-title" id="optionalFeeModalLabel">
                    <i class="fas fa-tags me-2"></i>Optional Fee Categories Changed
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You have changed the optional fee categories for this student. Do you want to apply this change to terms?</p>
                
                <div class="mb-3">
                    <div class="d-flex gap-4">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="optionalFeeApplyOption" id="optionalFeeApplyToTerms" value="apply" checked>
                            <label class="form-check-label" for="optionalFeeApplyToTerms">
                                <strong>Apply changes to terms</strong>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="optionalFeeApplyOption" id="optionalFeeDontApply" value="dont_apply">
                            <label class="form-check-label" for="optionalFeeDontApply">
                                <strong>Don't apply to terms</strong>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div id="optionalFeeTermsSelection" class="mb-3">
                    <label class="form-label">Select Terms:</label>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="selectAllOptionalFeeTerms" checked>
                        <label class="form-check-label" for="selectAllOptionalFeeTerms">
                            <strong>Select All</strong>
                        </label>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 10px;">
                        {% for term in terms %}
                        <div class="form-check">
                            <input class="form-check-input optional-fee-term-checkbox" type="checkbox" 
                                   value="{{ term.id }}" 
                                   id="optional_fee_term_{{ term.id }}"
                                   data-term-id="{{ term.id }}"
                                   checked>
                            <label class="form-check-label" for="optional_fee_term_{{ term.id }}">
                                {{ term.academic_year }} - Term {{ term.term_number }}
                                {% if term.is_active %}<span class="badge bg-success ms-2">Active</span>{% endif %}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="alert alert-info mt-2 mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>Optional fees will be added or removed for the selected terms based on your changes.</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="confirmOptionalFeeChange">
                    <i class="fas fa-check me-2"></i>Apply Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Combined Modal for Both Transport Route and Optional Fee Changes -->
{% if student %}
<div class="modal fade" id="combinedChangeModal" tabindex="-1" aria-labelledby="combinedChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="combinedChangeModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Multiple Changes Detected
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">You have changed both the transport route and optional fee categories for this student. Do you want to apply these changes to terms?</p>
                
                <div class="mb-3">
                    <div class="d-flex gap-4">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="combinedApplyOption" id="combinedApplyToTerms" value="apply" checked>
                            <label class="form-check-label" for="combinedApplyToTerms">
                                <strong>Apply changes to terms</strong>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="combinedApplyOption" id="combinedDontApply" value="dont_apply">
                            <label class="form-check-label" for="combinedDontApply">
                                <strong>Don't apply to terms</strong>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div id="combinedTermsSelection">
                    <div class="row g-3">
                        <!-- Transport Route Section -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0"><i class="fas fa-route me-2"></i>Transport Route Changes</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Select Terms for Transport Route:</label>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="selectAllTransportTerms" checked>
                                            <label class="form-check-label" for="selectAllTransportTerms">
                                                <strong>Select All</strong>
                                            </label>
                                        </div>
                                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 10px;">
                                            {% for term in terms %}
                                            <div class="form-check">
                                                <input class="form-check-input combined-transport-term-checkbox" type="checkbox" 
                                                       value="{{ term.id }}" 
                                                       id="combined_transport_term_{{ term.id }}"
                                                       data-term-id="{{ term.id }}"
                                                       checked>
                                                <label class="form-check-label" for="combined_transport_term_{{ term.id }}">
                                                    {{ term.academic_year }} - Term {{ term.term_number }}
                                                    {% if term.is_active %}<span class="badge bg-success ms-2">Active</span>{% endif %}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="alert alert-warning mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <small>Transport fees will be updated (or removed if route is cleared) for the selected terms.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Optional Fee Categories Section -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-info text-dark">
                                    <h6 class="mb-0"><i class="fas fa-tags me-2"></i>Optional Fee Categories Changes</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Select Terms for Optional Fees:</label>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="selectAllOptionalFeeTermsCombined" checked>
                                            <label class="form-check-label" for="selectAllOptionalFeeTermsCombined">
                                                <strong>Select All</strong>
                                            </label>
                                        </div>
                                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 10px;">
                                            {% for term in terms %}
                                            <div class="form-check">
                                                <input class="form-check-input combined-optional-fee-term-checkbox" type="checkbox" 
                                                       value="{{ term.id }}" 
                                                       id="combined_optional_fee_term_{{ term.id }}"
                                                       data-term-id="{{ term.id }}"
                                                       checked>
                                                <label class="form-check-label" for="combined_optional_fee_term_{{ term.id }}">
                                                    {{ term.academic_year }} - Term {{ term.term_number }}
                                                    {% if term.is_active %}<span class="badge bg-success ms-2">Active</span>{% endif %}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <small>Optional fees will be added or removed for the selected terms based on your changes.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmCombinedChange">
                    <i class="fas fa-check me-2"></i>Apply Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Declare variables in outer scope for accessibility
    const studentForm = document.getElementById('studentForm');
    const submitButton = document.getElementById('submitStudentForm');
    let checkFormChanges = null; // Declare in outer scope
    let initialParentIds = []; // Store initial parent IDs (will be set after parent selection code initializes)
    
    // Function to get current parent IDs from hidden inputs (for form change detection)
    // This function needs to be accessible to both form change detection and parent selection code
    function getCurrentParentIds() {
        if (!studentForm) return [];
        const parentInputs = studentForm.querySelectorAll('input[name="parents"]');
        return Array.from(parentInputs)
            .map(input => input.value)
            .filter(value => value) // Filter out empty values
            .sort();
    }
    
    // Track form changes to enable/disable submit button (only for updates, not new students)
    {% if student %}
    if (studentForm && submitButton) {
        // Store initial form values
        const initialFormData = new FormData(studentForm);
        const initialValues = {};
        
        // Get all form inputs, selects, and textareas
        const formInputs = studentForm.querySelectorAll('input, select, textarea');
        formInputs.forEach(function(input) {
            if (input.type === 'checkbox' || input.type === 'radio') {
                // For checkboxes/radios, use a unique identifier (id or name+value)
                // since multiple checkboxes can have the same name
                const checkboxId = input.id || input.name + '_' + input.value;
                initialValues[checkboxId] = input.checked;
                // Also store by name for backward compatibility with single checkboxes
                if (!input.id) {
                    initialValues[input.name] = input.checked;
                }
            } else if (input.type === 'file') {
                // File inputs are handled separately
                initialValues[input.name] = input.files.length > 0 ? 'has_file' : '';
            } else {
                initialValues[input.name] = input.value;
            }
        });
        
        // Function to check if form has changed
        checkFormChanges = function() {
            let hasChanges = false;
            
                formInputs.forEach(function(input) {
                if (input.name && input.name !== 'csrfmiddlewaretoken') {
                    let currentValue;
                    let initialValue;
                    
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        currentValue = input.checked;
                        // For checkboxes/radios, use unique identifier
                        const checkboxId = input.id || input.name + '_' + input.value;
                        initialValue = initialValues[checkboxId];
                        // Fallback to name if id-based lookup fails
                        if (initialValue === undefined) {
                            initialValue = initialValues[input.name];
                        }
                    } else if (input.type === 'file') {
                        currentValue = input.files.length > 0 ? 'has_file' : '';
                        initialValue = initialValues[input.name];
                    } else {
                        currentValue = input.value;
                        initialValue = initialValues[input.name];
                    }
                    
                    // Compare values (handle undefined/null cases)
                    if (initialValue !== undefined && currentValue !== initialValue) {
                        hasChanges = true;
                    }
                }
            });
            
            // Also check for optional fee categories (many-to-many field)
            // For checkboxes with the same name, we need to compare arrays of checked values
            const optionalFeeCheckboxes = studentForm.querySelectorAll('input[name="optional_fee_categories"]');
            if (optionalFeeCheckboxes.length > 0) {
                // Get initial checked values (stored during initialization)
                const initialOptionalFees = Array.from(optionalFeeCheckboxes)
                    .filter(cb => {
                        // Check if this checkbox was initially checked
                        const checkboxId = cb.id || cb.name + '_' + cb.value;
                        return initialValues[checkboxId] === true;
                    })
                    .map(cb => cb.value)
                    .sort();
                
                const currentOptionalFees = Array.from(optionalFeeCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value)
                    .sort();
                
                if (JSON.stringify(initialOptionalFees) !== JSON.stringify(currentOptionalFees)) {
                    hasChanges = true;
                }
            }
            
            // Check for parent changes (many-to-many field)
            const currentParentIds = getCurrentParentIds();
            if (JSON.stringify(initialParentIds) !== JSON.stringify(currentParentIds)) {
                hasChanges = true;
            }
            
            // Enable/disable submit button based on changes
            submitButton.disabled = !hasChanges;
            
            return hasChanges;
        }
        
        // Add event listeners to all form inputs
        formInputs.forEach(function(input) {
            input.addEventListener('change', checkFormChanges);
            input.addEventListener('input', checkFormChanges);
        });
        
        // Also listen for file input changes
        const fileInputs = studentForm.querySelectorAll('input[type="file"]');
        fileInputs.forEach(function(input) {
            input.addEventListener('change', function() {
                // Update initial value when file is selected
                initialValues[input.name] = input.files.length > 0 ? 'has_file' : '';
                checkFormChanges();
            });
        });
        
        // Initial check (should be disabled if no changes)
        checkFormChanges();
    }
    {% endif %}
    
    const gradeSelect = document.getElementById('{{ form.grade.id_for_label }}');
    const classSelect = document.getElementById('{{ form.school_class.id_for_label }}');
    
    if (gradeSelect && classSelect) {
        // Store all class options with their grade data
        const allClassOptions = [];
        const selectedClassValue = classSelect.value; // Store the currently selected value
        
        Array.from(classSelect.options).forEach(function(option) {
            if (option.value) {
                allClassOptions.push({
                    value: option.value,
                    text: option.text,
                    gradeId: option.getAttribute('data-grade-id') || null,
                    teacherName: option.getAttribute('data-teacher-name') || null,
                    teacherId: option.getAttribute('data-teacher-id') || null
                });
            }
        });
        
        // Get teacher display element
        const teacherDisplay = document.getElementById('class_teacher_display');
        const teacherNameSpan = document.getElementById('class_teacher_name');
        
        // Function to display teacher for selected class
        function displayClassTeacher(classOption) {
            if (classOption && classOption.teacherName) {
                teacherNameSpan.textContent = classOption.teacherName;
                teacherDisplay.style.display = 'block';
            } else {
                teacherDisplay.style.display = 'none';
            }
        }
        
        // Function to filter classes by grade
        function filterClassesByGrade(gradeId) {
            // Clear current options except the first one
            classSelect.innerHTML = '<option value="">---------</option>';
            
            if (gradeId) {
                // Filter and add classes for the selected grade
                allClassOptions.forEach(function(classOption) {
                    if (classOption.gradeId === gradeId) {
                        const option = document.createElement('option');
                        option.value = classOption.value;
                        option.textContent = classOption.text;
                        option.setAttribute('data-grade-id', classOption.gradeId);
                        if (classOption.teacherName) {
                            option.setAttribute('data-teacher-name', classOption.teacherName);
                            option.setAttribute('data-teacher-id', classOption.teacherId || '');
                        }
                        // Restore selected value if it matches
                        if (classOption.value === selectedClassValue) {
                            option.selected = true;
                            // Display teacher for initially selected class
                            displayClassTeacher(classOption);
                        }
                        classSelect.appendChild(option);
                    }
                });
            } else {
                // No grade selected, show all classes
                allClassOptions.forEach(function(classOption) {
                    const option = document.createElement('option');
                    option.value = classOption.value;
                    option.textContent = classOption.text;
                    option.setAttribute('data-grade-id', classOption.gradeId);
                    if (classOption.teacherName) {
                        option.setAttribute('data-teacher-name', classOption.teacherName);
                        option.setAttribute('data-teacher-id', classOption.teacherId || '');
                    }
                    // Restore selected value if it matches
                    if (classOption.value === selectedClassValue) {
                        option.selected = true;
                        // Display teacher for initially selected class
                        displayClassTeacher(classOption);
                    }
                    classSelect.appendChild(option);
                });
            }
        }
        
        // Add event listener for grade change
        gradeSelect.addEventListener('change', function() {
            filterClassesByGrade(this.value);
            // Clear teacher display when grade changes
            teacherDisplay.style.display = 'none';
        });
        
        // Add event listener for class change
        classSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.value) {
                // Get teacher info from the selected option's data attributes
                const teacherName = selectedOption.getAttribute('data-teacher-name');
                if (teacherName) {
                    teacherNameSpan.textContent = teacherName;
                    teacherDisplay.style.display = 'block';
                } else {
                    // Try to find in allClassOptions as fallback
                    const selectedClassData = allClassOptions.find(function(opt) {
                        return opt.value === selectedOption.value;
                    });
                    displayClassTeacher(selectedClassData);
                }
            } else {
                teacherDisplay.style.display = 'none';
            }
        });
        
        // Filter on page load if grade is already selected
        if (gradeSelect.value) {
            filterClassesByGrade(gradeSelect.value);
        }
        
        // Display teacher for initially selected class on page load
        if (classSelect.value) {
            const initialSelectedOption = classSelect.options[classSelect.selectedIndex];
            if (initialSelectedOption && initialSelectedOption.value) {
                const initialClassData = allClassOptions.find(function(opt) {
                    return opt.value === initialSelectedOption.value;
                });
                displayClassTeacher(initialClassData);
            }
        }
    }
    
    // Optional Fee Categories handling
    {% if student %}
    const optionalFeeCheckboxes = studentForm.querySelectorAll('input[name="optional_fee_categories"]');
    const optionalFeeModal = document.getElementById('optionalFeeModal');
    const combinedChangeModal = document.getElementById('combinedChangeModal');
    const selectAllOptionalFeeTerms = document.getElementById('selectAllOptionalFeeTerms');
    const optionalFeeTermCheckboxes = document.querySelectorAll('.optional-fee-term-checkbox');
    const optionalFeeTermCheckboxesHidden = document.querySelectorAll('.optional-fee-term-checkbox-hidden');
    const confirmOptionalFeeChange = document.getElementById('confirmOptionalFeeChange');
    
    // Combined modal elements
    const selectAllTransportTermsCombined = document.getElementById('selectAllTransportTerms');
    const selectAllOptionalFeeTermsCombined = document.getElementById('selectAllOptionalFeeTermsCombined');
    const combinedTransportTermCheckboxes = document.querySelectorAll('.combined-transport-term-checkbox');
    const combinedOptionalFeeTermCheckboxes = document.querySelectorAll('.combined-optional-fee-term-checkbox');
    const confirmCombinedChange = document.getElementById('confirmCombinedChange');
    
    let originalOptionalFees = [];
    let optionalFeeModalConfirmed = false;
    let modalShownForOptionalFeeChange = false;
    let combinedModalConfirmed = false;
    
    if (optionalFeeCheckboxes.length > 0 && optionalFeeModal && studentForm) {
        // Store original optional fee selections on page load
        originalOptionalFees = Array.from(optionalFeeCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value)
            .sort();
        
        // Function to check if optional fees changed
        function checkOptionalFeesChanged() {
            const currentOptionalFees = Array.from(optionalFeeCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value)
                .sort();
            
            return JSON.stringify(originalOptionalFees) !== JSON.stringify(currentOptionalFees);
        }
        
        // Sync visible checkboxes with hidden checkboxes in form
        function syncOptionalFeeCheckboxes() {
            optionalFeeTermCheckboxes.forEach(function(visibleCheckbox) {
                const termId = visibleCheckbox.getAttribute('data-term-id');
                const hiddenCheckbox = document.getElementById('optional_fee_term_hidden_' + termId);
                if (hiddenCheckbox) {
                    hiddenCheckbox.checked = visibleCheckbox.checked;
                }
            });
        }
        
        // Handle "Select All" checkbox for optional fees
        if (selectAllOptionalFeeTerms) {
            selectAllOptionalFeeTerms.addEventListener('change', function() {
                optionalFeeTermCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = this.checked;
                }, this);
                syncOptionalFeeCheckboxes();
            });
        }
        
        // Sync when individual checkboxes change
        optionalFeeTermCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', syncOptionalFeeCheckboxes);
        });
        
        // Handle radio buttons for optional fees - show/hide term selection
        const optionalFeeApplyToTerms = document.getElementById('optionalFeeApplyToTerms');
        const optionalFeeDontApply = document.getElementById('optionalFeeDontApply');
        const optionalFeeTermsSelection = document.getElementById('optionalFeeTermsSelection');
        
        // Function to check if Apply Changes button should be enabled for optional fees
        function checkOptionalFeeApplyButtonState() {
            if (!confirmOptionalFeeChange) return;
            
            if (optionalFeeDontApply && optionalFeeDontApply.checked) {
                // If "Don't apply to terms" is selected, button is always enabled
                confirmOptionalFeeChange.disabled = false;
            } else if (optionalFeeApplyToTerms && optionalFeeApplyToTerms.checked) {
                // If "Apply changes to terms" is selected, check if at least one term is selected
                const selectedTerms = Array.from(optionalFeeTermCheckboxes).filter(cb => cb.checked);
                confirmOptionalFeeChange.disabled = selectedTerms.length === 0;
            }
        }
        
        if (optionalFeeApplyToTerms && optionalFeeDontApply && optionalFeeTermsSelection) {
            function toggleOptionalFeeTermsSelection() {
                if (optionalFeeApplyToTerms.checked) {
                    optionalFeeTermsSelection.style.display = 'block';
                } else {
                    optionalFeeTermsSelection.style.display = 'none';
                    // Uncheck all when hidden
                    optionalFeeTermCheckboxes.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    optionalFeeTermCheckboxesHidden.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    if (selectAllOptionalFeeTerms) {
                        selectAllOptionalFeeTerms.checked = false;
                    }
                }
                checkOptionalFeeApplyButtonState();
            }
            
            optionalFeeApplyToTerms.addEventListener('change', toggleOptionalFeeTermsSelection);
            optionalFeeDontApply.addEventListener('change', toggleOptionalFeeTermsSelection);
        }
        
        // Update button state when term checkboxes change
        optionalFeeTermCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', checkOptionalFeeApplyButtonState);
        });
        
        if (selectAllOptionalFeeTerms) {
            selectAllOptionalFeeTerms.addEventListener('change', function() {
                checkOptionalFeeApplyButtonState();
            });
        }
        
        // Handle confirm button for optional fees
        if (confirmOptionalFeeChange) {
            confirmOptionalFeeChange.addEventListener('click', function() {
                const applyToTerms = optionalFeeApplyToTerms && optionalFeeApplyToTerms.checked;
                
                if (applyToTerms) {
                    // Check if at least one term is selected
                    const selectedTerms = Array.from(optionalFeeTermCheckboxes).filter(cb => cb.checked);
                    
                    if (selectedTerms.length === 0) {
                        alert('Please select at least one term.');
                        return;
                    }
                    
                    // Sync checkboxes BEFORE closing modal
                    syncOptionalFeeCheckboxes();
                } else {
                    // Uncheck all term checkboxes (both visible and hidden)
                    optionalFeeTermCheckboxes.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    optionalFeeTermCheckboxesHidden.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                }
                
                // Mark as confirmed
                optionalFeeModalConfirmed = true;
                modalShownForOptionalFeeChange = false;
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(optionalFeeModal);
                modal.hide();
                
                // Submit the form after modal closes
                setTimeout(function() {
                    if (applyToTerms) {
                        // Double-check sync before submitting
                        syncOptionalFeeCheckboxes();
                        const finalSelected = Array.from(optionalFeeTermCheckboxesHidden).filter(cb => cb.checked).map(cb => cb.value);
                        
                        if (finalSelected.length === 0) {
                            console.error('ERROR: No terms selected for optional fees!');
                            alert('Error: No terms were selected. Please try again.');
                            return;
                        }
                    }
                    
                    // Submit the form
                    if (studentForm.requestSubmit) {
                        studentForm.requestSubmit();
                    } else {
                        studentForm.submit();
                    }
                }, 300);
            });
        }
        
        // Handle modal cancel/close - reset optional fees to original value if dismissed
        optionalFeeModal.addEventListener('hidden.bs.modal', function() {
            // If modal was closed without confirming and it was shown for an optional fee change
            if (!optionalFeeModalConfirmed && modalShownForOptionalFeeChange) {
                // Reset optional fees to original values
                optionalFeeCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = originalOptionalFees.includes(checkbox.value);
                });
                
                // Uncheck all terms
                optionalFeeTermCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = false;
                });
                // Uncheck all hidden checkboxes
                optionalFeeTermCheckboxesHidden.forEach(function(checkbox) {
                    checkbox.checked = false;
                });
                
                // Reset flags
                optionalFeeModalConfirmed = false;
                modalShownForOptionalFeeChange = false;
                
                // Trigger form change check to update button state
                if (typeof checkFormChanges === 'function') {
                    checkFormChanges();
                }
                
                // Do NOT submit the form - let user decide what to do next
            } else if (optionalFeeModalConfirmed) {
                // Modal was confirmed, so flags are already reset
                modalShownForOptionalFeeChange = false;
            }
        });
    }
    {% endif %}
    
    // Transport Route handling
    const transportRouteSelect = document.getElementById('{{ form.transport_route.id_for_label }}');
    const transportRouteInfo = document.getElementById('transport_route_info');
    const routeFareDisplay = document.getElementById('route_fare_display');
    // studentForm is already declared at function scope above
    const transportRouteModal = document.getElementById('transportRouteModal');
    const selectAllTerms = document.getElementById('selectAllTerms');
    const termCheckboxes = document.querySelectorAll('.term-checkbox');
    const termCheckboxesHidden = document.querySelectorAll('.term-checkbox-hidden');
    const confirmTransportChange = document.getElementById('confirmTransportChange');
    
    let originalRouteValue = transportRouteSelect ? transportRouteSelect.value : '';
    let modalConfirmed = false;
    
    if (transportRouteSelect) {
        // Function to update transport route info
        function updateTransportRouteInfo() {
            const selectedOption = transportRouteSelect.options[transportRouteSelect.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                const fare = selectedOption.getAttribute('data-fare');
                if (fare) {
                    routeFareDisplay.textContent = 'KES ' + parseFloat(fare).toFixed(2);
                    transportRouteInfo.style.display = 'block';
                } else {
                    transportRouteInfo.style.display = 'none';
                }
            } else {
                transportRouteInfo.style.display = 'none';
            }
        }
        
        // Add event listener for transport route change
        transportRouteSelect.addEventListener('change', updateTransportRouteInfo);
        
        // Update on page load if route is already selected
        if (transportRouteSelect.value) {
            updateTransportRouteInfo();
        }
    }
    
    // Handle transport route change prompt (only for existing students)
    {% if student %}
    if (transportRouteSelect && transportRouteModal && studentForm) {
        // Store original value on page load
        originalRouteValue = transportRouteSelect.value;
        let modalShownForRouteChange = false; // Track if modal was shown due to route change
        
        // Sync functions for combined modal
        function syncCombinedTransportCheckboxes() {
            combinedTransportTermCheckboxes.forEach(function(visibleCheckbox) {
                const termId = visibleCheckbox.getAttribute('data-term-id');
                const hiddenCheckbox = document.getElementById('term_hidden_' + termId);
                if (hiddenCheckbox) {
                    hiddenCheckbox.checked = visibleCheckbox.checked;
                }
            });
        }
        
        function syncCombinedOptionalFeeCheckboxes() {
            combinedOptionalFeeTermCheckboxes.forEach(function(visibleCheckbox) {
                const termId = visibleCheckbox.getAttribute('data-term-id');
                const hiddenCheckbox = document.getElementById('optional_fee_term_hidden_' + termId);
                if (hiddenCheckbox) {
                    hiddenCheckbox.checked = visibleCheckbox.checked;
                }
            });
        }
        
        // Handle combined modal checkboxes
        if (selectAllTransportTermsCombined) {
            selectAllTransportTermsCombined.addEventListener('change', function() {
                combinedTransportTermCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = this.checked;
                }, this);
                syncCombinedTransportCheckboxes();
            });
        }
        
        combinedTransportTermCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', syncCombinedTransportCheckboxes);
        });
        
        if (selectAllOptionalFeeTermsCombined) {
            selectAllOptionalFeeTermsCombined.addEventListener('change', function() {
                combinedOptionalFeeTermCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = this.checked;
                }, this);
                syncCombinedOptionalFeeCheckboxes();
            });
        }
        
        combinedOptionalFeeTermCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', syncCombinedOptionalFeeCheckboxes);
        });
        
        // Handle radio buttons for combined modal - show/hide term selection
        const combinedApplyToTerms = document.getElementById('combinedApplyToTerms');
        const combinedDontApply = document.getElementById('combinedDontApply');
        const combinedTermsSelection = document.getElementById('combinedTermsSelection');
        
        // Function to check if Apply Changes button should be enabled for combined modal
        function checkCombinedApplyButtonState() {
            if (!confirmCombinedChange) return;
            
            if (combinedDontApply && combinedDontApply.checked) {
                // If "Don't apply to terms" is selected, button is always enabled
                confirmCombinedChange.disabled = false;
            } else if (combinedApplyToTerms && combinedApplyToTerms.checked) {
                // If "Apply changes to terms" is selected, check if at least one term is selected in EITHER category
                const selectedTransportTerms = Array.from(combinedTransportTermCheckboxes).filter(cb => cb.checked);
                const selectedOptionalFeeTerms = Array.from(combinedOptionalFeeTermCheckboxes).filter(cb => cb.checked);
                confirmCombinedChange.disabled = selectedTransportTerms.length === 0 && selectedOptionalFeeTerms.length === 0;
            }
        }
        
        if (combinedApplyToTerms && combinedDontApply && combinedTermsSelection) {
            function toggleCombinedTermsSelection() {
                if (combinedApplyToTerms.checked) {
                    combinedTermsSelection.style.display = 'block';
                } else {
                    combinedTermsSelection.style.display = 'none';
                    // Uncheck all when hidden
                    combinedTransportTermCheckboxes.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    combinedOptionalFeeTermCheckboxes.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    termCheckboxesHidden.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    optionalFeeTermCheckboxesHidden.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    if (selectAllTransportTermsCombined) {
                        selectAllTransportTermsCombined.checked = false;
                    }
                    if (selectAllOptionalFeeTermsCombined) {
                        selectAllOptionalFeeTermsCombined.checked = false;
                    }
                }
                checkCombinedApplyButtonState();
            }
            
            combinedApplyToTerms.addEventListener('change', toggleCombinedTermsSelection);
            combinedDontApply.addEventListener('change', toggleCombinedTermsSelection);
        }
        
        // Update button state when term checkboxes change
        combinedTransportTermCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', checkCombinedApplyButtonState);
        });
        combinedOptionalFeeTermCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', checkCombinedApplyButtonState);
        });
        
        if (selectAllTransportTermsCombined) {
            selectAllTransportTermsCombined.addEventListener('change', function() {
                checkCombinedApplyButtonState();
            });
        }
        if (selectAllOptionalFeeTermsCombined) {
            selectAllOptionalFeeTermsCombined.addEventListener('change', function() {
                checkCombinedApplyButtonState();
            });
        }
        
        // Handle confirm button for combined modal
        if (confirmCombinedChange) {
            confirmCombinedChange.addEventListener('click', function() {
                const applyToTerms = combinedApplyToTerms && combinedApplyToTerms.checked;
                
                if (applyToTerms) {
                    // Check if at least one term is selected in either category
                    const selectedTransportTerms = Array.from(combinedTransportTermCheckboxes).filter(cb => cb.checked);
                    const selectedOptionalFeeTerms = Array.from(combinedOptionalFeeTermCheckboxes).filter(cb => cb.checked);
                    
                    if (selectedTransportTerms.length === 0 && selectedOptionalFeeTerms.length === 0) {
                        alert('Please select at least one term for transport route or optional fees.');
                        return;
                    }
                    
                    // Sync checkboxes for categories that have selections
                    // If transport has selections, sync transport checkboxes
                    if (selectedTransportTerms.length > 0) {
                        syncCombinedTransportCheckboxes();
                    } else {
                        // If no transport terms selected, uncheck all transport hidden checkboxes
                        termCheckboxesHidden.forEach(function(checkbox) {
                            checkbox.checked = false;
                        });
                    }
                    
                    // If optional fees has selections, sync optional fee checkboxes
                    if (selectedOptionalFeeTerms.length > 0) {
                        syncCombinedOptionalFeeCheckboxes();
                    } else {
                        // If no optional fee terms selected, uncheck all optional fee hidden checkboxes
                        optionalFeeTermCheckboxesHidden.forEach(function(checkbox) {
                            checkbox.checked = false;
                        });
                    }
                } else {
                    // Uncheck all term checkboxes (both visible and hidden) for both transport and optional fees
                    combinedTransportTermCheckboxes.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    combinedOptionalFeeTermCheckboxes.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    termCheckboxesHidden.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    optionalFeeTermCheckboxesHidden.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                }
                
                // Mark both modals as confirmed
                modalConfirmed = true;
                optionalFeeModalConfirmed = true;
                combinedModalConfirmed = true;
                modalShownForRouteChange = false;
                modalShownForOptionalFeeChange = false;
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(combinedChangeModal);
                modal.hide();
                
                // Submit the form after modal closes
                setTimeout(function() {
                    // Submit the form (backend will handle applying only to categories with selected terms)
                    if (studentForm.requestSubmit) {
                        studentForm.requestSubmit();
                    } else {
                        studentForm.submit();
                    }
                }, 300);
            });
        }
        
        // Handle combined modal cancel/close
        if (combinedChangeModal) {
            combinedChangeModal.addEventListener('hidden.bs.modal', function() {
                // If modal was closed without confirming
                if (!combinedModalConfirmed) {
                    // Reset transport route to original value
                    transportRouteSelect.value = originalRouteValue;
                    
                    // Reset optional fees to original values
                    optionalFeeCheckboxes.forEach(function(checkbox) {
                        checkbox.checked = originalOptionalFees.includes(checkbox.value);
                    });
                    
                    // Uncheck all combined modal checkboxes
                    combinedTransportTermCheckboxes.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    combinedOptionalFeeTermCheckboxes.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    // Uncheck all hidden checkboxes
                    termCheckboxesHidden.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    optionalFeeTermCheckboxesHidden.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    
                    // Reset flags
                    modalConfirmed = false;
                    optionalFeeModalConfirmed = false;
                    combinedModalConfirmed = false;
                    modalShownForRouteChange = false;
                    modalShownForOptionalFeeChange = false;
                    
                    // Trigger form change check to update button state
                    if (typeof checkFormChanges === 'function') {
                        checkFormChanges();
                    }
                } else {
                    // Modal was confirmed, reset flags
                    combinedModalConfirmed = false;
                }
            });
        }
        
        // Intercept form submission
        studentForm.addEventListener('submit', function(e) {
            const currentRouteValue = transportRouteSelect.value;
            const routeChanged = currentRouteValue !== originalRouteValue;
            const optionalFeesChanged = (typeof checkOptionalFeesChanged === 'function') ? checkOptionalFeesChanged() : false;
            
            // Check if BOTH changed - show combined modal
            if (routeChanged && optionalFeesChanged && !combinedModalConfirmed && combinedChangeModal) {
                e.preventDefault();
                e.stopPropagation();
                
                // Reset modal states
                modalConfirmed = false;
                optionalFeeModalConfirmed = false;
                combinedModalConfirmed = false;
                modalShownForRouteChange = true;
                modalShownForOptionalFeeChange = true;
                
                // Ensure all visible checkboxes in combined modal are checked
                combinedTransportTermCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = true;
                });
                combinedOptionalFeeTermCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = true;
                });
                if (selectAllTransportTermsCombined) {
                    selectAllTransportTermsCombined.checked = true;
                }
                if (selectAllOptionalFeeTermsCombined) {
                    selectAllOptionalFeeTermsCombined.checked = true;
                }
                
                // Sync checkboxes to default (all checked) before showing modal
                syncCombinedTransportCheckboxes();
                syncCombinedOptionalFeeCheckboxes();
                
                // Ensure radio button is set to "Apply changes to terms"
                if (combinedApplyToTerms) {
                    combinedApplyToTerms.checked = true;
                }
                if (combinedTermsSelection) {
                    combinedTermsSelection.style.display = 'block';
                }
                
                // Update button state
                checkCombinedApplyButtonState();
                
                // Show combined modal
                const modal = new bootstrap.Modal(combinedChangeModal);
                modal.show();
                
                return false;
            }
            
            // Check if only optional fees changed and modal hasn't been confirmed
            if (optionalFeesChanged && !routeChanged && !optionalFeeModalConfirmed && optionalFeeModal) {
                e.preventDefault();
                e.stopPropagation();
                
                // Reset modal state
                optionalFeeModalConfirmed = false;
                modalShownForOptionalFeeChange = true;
                
                // Ensure all visible checkboxes are checked (they should be by default, but just in case)
                optionalFeeTermCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = true;
                });
                if (selectAllOptionalFeeTerms) {
                    selectAllOptionalFeeTerms.checked = true;
                }
                
                // Sync checkboxes to default (all checked) before showing modal
                syncOptionalFeeCheckboxes();
                
                // Ensure radio button is set to "Apply changes to terms"
                if (optionalFeeApplyToTerms) {
                    optionalFeeApplyToTerms.checked = true;
                }
                if (optionalFeeTermsSelection) {
                    optionalFeeTermsSelection.style.display = 'block';
                }
                
                // Update button state
                checkOptionalFeeApplyButtonState();
                
                // Show modal
                const modal = new bootstrap.Modal(optionalFeeModal);
                modal.show();
                
                return false;
            }
            
            // Check if only transport route changed and modal hasn't been confirmed
            if (routeChanged && !optionalFeesChanged && !modalConfirmed) {
                e.preventDefault();
                e.stopPropagation();
                
                // Reset modal state
                modalConfirmed = false;
                modalShownForRouteChange = true; // Mark that modal is being shown for route change
                
                // Ensure all visible checkboxes are checked (they should be by default, but just in case)
                termCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = true;
                });
                if (selectAllTerms) {
                    selectAllTerms.checked = true;
                }
                
                // Sync checkboxes to default (all checked) before showing modal
                syncCheckboxes();
                
                // Ensure radio button is set to "Apply changes to terms"
                if (transportApplyToTerms) {
                    transportApplyToTerms.checked = true;
                }
                if (transportTermsSelection) {
                    transportTermsSelection.style.display = 'block';
                }
                
                // Update button state
                checkTransportApplyButtonState();
                
                // Show modal
                const modal = new bootstrap.Modal(transportRouteModal);
                modal.show();
                
                return false;
            }
        });
        
        // Sync visible checkboxes with hidden checkboxes in form
        function syncCheckboxes() {
            let syncedCount = 0;
            termCheckboxes.forEach(function(visibleCheckbox) {
                const termId = visibleCheckbox.getAttribute('data-term-id');
                const hiddenCheckbox = document.getElementById('term_hidden_' + termId);
                if (hiddenCheckbox) {
                    hiddenCheckbox.checked = visibleCheckbox.checked;
                    syncedCount++;
                } else {
                    console.warn('Hidden checkbox not found for term:', termId);
                }
            });
            // Debug logging (can be removed in production)
            // console.log(`Synced ${syncedCount} checkboxes. Visible: ${termCheckboxes.length}, Hidden: ${termCheckboxesHidden.length}`);
            return syncedCount;
        }
        
        // Don't sync on page load - only sync when modal is shown or when user interacts
        
        // Handle "Select All" checkbox
        if (selectAllTerms) {
            selectAllTerms.addEventListener('change', function() {
                termCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = this.checked;
                }, this);
                syncCheckboxes();
            });
        }
        
        // Sync when individual checkboxes change
        termCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', syncCheckboxes);
        });
        
        // Handle radio buttons for transport route - show/hide term selection
        const transportApplyToTerms = document.getElementById('transportApplyToTerms');
        const transportDontApply = document.getElementById('transportDontApply');
        const transportTermsSelection = document.getElementById('transportTermsSelection');
        
        // Function to check if Apply Changes button should be enabled for transport route
        function checkTransportApplyButtonState() {
            if (!confirmTransportChange) return;
            
            if (transportDontApply && transportDontApply.checked) {
                // If "Don't apply to terms" is selected, button is always enabled
                confirmTransportChange.disabled = false;
            } else if (transportApplyToTerms && transportApplyToTerms.checked) {
                // If "Apply changes to terms" is selected, check if at least one term is selected
                const selectedTerms = Array.from(termCheckboxes).filter(cb => cb.checked);
                confirmTransportChange.disabled = selectedTerms.length === 0;
            }
        }
        
        if (transportApplyToTerms && transportDontApply && transportTermsSelection) {
            function toggleTransportTermsSelection() {
                if (transportApplyToTerms.checked) {
                    transportTermsSelection.style.display = 'block';
                } else {
                    transportTermsSelection.style.display = 'none';
                    // Uncheck all when hidden
                    termCheckboxes.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    termCheckboxesHidden.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    if (selectAllTerms) {
                        selectAllTerms.checked = false;
                    }
                }
                checkTransportApplyButtonState();
            }
            
            transportApplyToTerms.addEventListener('change', toggleTransportTermsSelection);
            transportDontApply.addEventListener('change', toggleTransportTermsSelection);
        }
        
        // Update button state when term checkboxes change
        termCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', checkTransportApplyButtonState);
        });
        
        if (selectAllTerms) {
            selectAllTerms.addEventListener('change', function() {
                checkTransportApplyButtonState();
            });
        }
        
        // Handle confirm button
        if (confirmTransportChange) {
            confirmTransportChange.addEventListener('click', function() {
                const applyToTerms = transportApplyToTerms && transportApplyToTerms.checked;
                
                if (applyToTerms) {
                    // Check if at least one term is selected
                    const selectedTerms = Array.from(termCheckboxes).filter(cb => cb.checked);
                    
                    if (selectedTerms.length === 0) {
                        alert('Please select at least one term.');
                        return;
                    }
                    
                    // Sync checkboxes BEFORE closing modal
                    syncCheckboxes();
                } else {
                    // Uncheck all term checkboxes (both visible and hidden)
                    termCheckboxes.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                    termCheckboxesHidden.forEach(function(checkbox) {
                        checkbox.checked = false;
                    });
                }
                
                // Mark as confirmed
                modalConfirmed = true;
                modalShownForRouteChange = false; // Reset flag
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(transportRouteModal);
                modal.hide();
                
                // Submit the form after modal closes
                setTimeout(function() {
                    if (applyToTerms) {
                        // Double-check sync before submitting - ensure all visible checked boxes sync to hidden
                        termCheckboxes.forEach(function(visibleCheckbox) {
                            if (visibleCheckbox.checked) {
                                const termId = visibleCheckbox.getAttribute('data-term-id');
                                const hiddenCheckbox = document.getElementById('term_hidden_' + termId);
                                if (hiddenCheckbox) {
                                    hiddenCheckbox.checked = true;
                                }
                            }
                        });
                        
                        const finalSelected = Array.from(termCheckboxesHidden).filter(cb => cb.checked).map(cb => cb.value);
                        
                        if (finalSelected.length === 0) {
                            console.error('ERROR: No terms selected! Checkboxes may not be syncing correctly.');
                            alert('Error: No terms were selected. Please try again.');
                            return;
                        }
                    }
                    
                    // Submit the form - modalConfirmed is true so submit handler won't intercept
                    if (studentForm.requestSubmit) {
                        studentForm.requestSubmit();
                    } else {
                        studentForm.submit();
                    }
                }, 300);
            });
        }
        
        // Handle modal cancel/close - reset route to original value if dismissed
        transportRouteModal.addEventListener('hidden.bs.modal', function() {
            // If modal was closed without confirming and it was shown for a route change
            if (!modalConfirmed && modalShownForRouteChange) {
                // Reset route to original value
                transportRouteSelect.value = originalRouteValue;
                // Trigger change event to update UI and check form changes
                transportRouteSelect.dispatchEvent(new Event('change'));
                
                // Uncheck all terms
                termCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = false;
                });
                // Uncheck all hidden checkboxes
                termCheckboxesHidden.forEach(function(checkbox) {
                    checkbox.checked = false;
                });
                
                // Reset flags
                modalConfirmed = false;
                modalShownForRouteChange = false;
                
                // Trigger form change check to update button state
                if (typeof checkFormChanges === 'function') {
                    checkFormChanges();
                }
                
                // Do NOT submit the form - let user decide what to do next
            } else if (modalConfirmed) {
                // Modal was confirmed, so flags are already reset
                modalShownForRouteChange = false;
            }
        });
    }
    {% endif %}
    
    // Parent/Guardian selection handling (similar to teacher specialization)
    const selectedParentsContainer = document.getElementById('selected-parents');
    const parentHiddenInput = document.getElementById('id_parents');
    const parentDropdownItems = document.querySelectorAll('.parent-item');
    const selectedParentValues = new Set();
    
    // Initialize with existing selections
    {% if student %}
        {% for parent in student.parents.all %}
            selectedParentValues.add('{{ parent.id }}');
        {% endfor %}
    {% else %}
        {% for parent in form.parents.value %}
            selectedParentValues.add('{{ parent }}');
        {% endfor %}
    {% endif %}
    
    // Function to update hidden inputs (Django expects multiple inputs with same name for many-to-many)
    function updateParentHiddenInput() {
        // Remove all existing parent hidden inputs (including the main one)
        const existingInputs = studentForm.querySelectorAll('input[name="parents"]');
        existingInputs.forEach(input => {
            input.remove();
        });
        
        // Create new hidden inputs for each selected parent
        selectedParentValues.forEach(value => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'parents';
            hiddenInput.value = value;
            studentForm.appendChild(hiddenInput);
        });
    }
    
    // Function to re-enable dropdown item
    function enableParentDropdownItem(value) {
        parentDropdownItems.forEach(item => {
            if (item.getAttribute('data-value') === value) {
                item.classList.remove('disabled');
                item.style.pointerEvents = '';
                item.style.opacity = '';
            }
        });
    }
    
    // Function to disable dropdown item
    function disableParentDropdownItem(value) {
        parentDropdownItems.forEach(item => {
            if (item.getAttribute('data-value') === value) {
                item.classList.add('disabled');
                item.style.pointerEvents = 'none';
                item.style.opacity = '0.5';
            }
        });
    }
    
    // Function to remove selected parent
    function removeSelectedParent(value) {
        selectedParentValues.delete(value);
        updateParentHiddenInput();
        enableParentDropdownItem(value);
        
        // Remove the badge from DOM
        const badge = selectedParentsContainer.querySelector(`[data-value="${value}"]`);
        if (badge) {
            badge.remove();
        }
        
        // Trigger form change check after a brief delay to ensure hidden inputs are updated
        if (typeof checkFormChanges === 'function') {
            setTimeout(function() {
                checkFormChanges();
            }, 0);
        }
    }
    
    // Function to add selected parent
    function addSelectedParent(value, text) {
        if (selectedParentValues.has(value)) {
            return; // Already selected
        }
        
        selectedParentValues.add(value);
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary me-1 mb-1';
        badge.setAttribute('data-value', value);
        badge.innerHTML = text + ' <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.7em;" aria-label="Remove"></button>';
        
        // Add remove functionality
        const removeBtn = badge.querySelector('.btn-close');
        removeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            removeSelectedParent(value);
        });
        
        selectedParentsContainer.appendChild(badge);
        updateParentHiddenInput();
        disableParentDropdownItem(value);
        
        // Trigger form change check after a brief delay to ensure hidden inputs are updated
        if (typeof checkFormChanges === 'function') {
            setTimeout(function() {
                checkFormChanges();
            }, 0);
        }
    }
    
    // Handle remove buttons for existing badges
    const existingParentBadges = selectedParentsContainer.querySelectorAll('.badge[data-value]');
    existingParentBadges.forEach(badge => {
        const removeBtn = badge.querySelector('.btn-close');
        if (removeBtn) {
            removeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const value = badge.getAttribute('data-value');
                removeSelectedParent(value);
            });
        }
    });
    
    // Handle dropdown item clicks
    parentDropdownItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const value = this.getAttribute('data-value');
            const text = this.getAttribute('data-text');
            
            if (!selectedParentValues.has(value)) {
                addSelectedParent(value, text);
            }
        });
        
        // Check if already selected and disable
        const value = item.getAttribute('data-value');
        if (selectedParentValues.has(value)) {
            disableParentDropdownItem(value);
        }
    });
    
    // Update hidden input on page load
    updateParentHiddenInput();
    
    // Initialize initial parent IDs after hidden inputs are created (for form change detection)
    {% if student %}
    // Set initial parent IDs after the hidden inputs are created
    initialParentIds = getCurrentParentIds();
    // Re-run form change check to ensure button state is correct
    if (typeof checkFormChanges === 'function') {
        checkFormChanges();
    }
    {% endif %}
});
</script>
{% endblock %}
