{% extends 'base.html' %}
{% block title %}{{ title|default:'Add Student' }} | School Management System{% endblock %}
{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">{{ title|default:'Add Student' }}</h4>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="post" enctype="multipart/form-data" novalidate id="studentForm">
                        {% csrf_token %}
                        
                        <!-- Hidden container for term checkboxes (inside form so they submit) -->
                        {% if student and terms %}
                        <div id="transportTermsContainer" style="display: none;">
                            {% for term in terms %}
                            <input type="checkbox" 
                                   class="term-checkbox-hidden" 
                                   name="apply_transport_to_terms" 
                                   value="{{ term.id }}" 
                                   id="term_hidden_{{ term.id }}">
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- Display form errors at the top -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}
                        
                        <div class="row g-3">
                            <!-- Student ID (Auto-generated) -->
                            <div class="col-md-4">
                                <label class="form-label">Student ID</label>
                                <input type="text" class="form-control" value="Auto-generated" disabled>
                                <div class="form-text">Student ID will be auto-generated</div>
                            </div>
                            
                            <!-- First Name -->
                            <div class="col-md-4">
                                <label for="{{ form.first_name.id_for_label }}" class="form-label">
                                    {{ form.first_name.label }}
                                    {% if form.first_name.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.first_name }}
                                {% if form.first_name.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.first_name.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Last Name -->
                            <div class="col-md-4">
                                <label for="{{ form.last_name.id_for_label }}" class="form-label">
                                    {{ form.last_name.label }}
                                    {% if form.last_name.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.last_name }}
                                {% if form.last_name.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.last_name.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Gender -->
                            <div class="col-md-4">
                                <label for="{{ form.gender.id_for_label }}" class="form-label">
                                    {{ form.gender.label }}
                                    {% if form.gender.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.gender }}
                                {% if form.gender.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.gender.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Date of Birth -->
                            <div class="col-md-4">
                                <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">
                                    {{ form.date_of_birth.label }}
                                    {% if form.date_of_birth.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.date_of_birth }}
                                {% if form.date_of_birth.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.date_of_birth.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Grade -->
                            <div class="col-md-4">
                                <label for="{{ form.grade.id_for_label }}" class="form-label">
                                    {{ form.grade.label }}
                                    {% if form.grade.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.grade }}
                                {% if form.grade.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.grade.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- School Class -->
                            <div class="col-md-4">
                                <label for="{{ form.school_class.id_for_label }}" class="form-label">
                                    {{ form.school_class.label }}
                                    {% if form.school_class.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                <select name="{{ form.school_class.name }}" id="{{ form.school_class.id_for_label }}" class="form-select">
                                    <option value="">---------</option>
                                    {% for choice in form.school_class.field.queryset %}
                                        <option value="{{ choice.id }}" 
                                                data-grade-id="{{ choice.grade.id }}"
                                                data-teacher-name="{% if choice.class_teacher %}{{ choice.class_teacher.full_name }}{% endif %}"
                                                data-teacher-id="{% if choice.class_teacher %}{{ choice.class_teacher.id }}{% endif %}"
                                                {% if form.school_class.value == choice.id %}selected{% endif %}>
                                            {{ choice.name }} ({{ choice.grade.name }})
                                        </option>
                                    {% endfor %}
                                </select>
                                <div id="class_teacher_display" class="mt-2" style="display: none;">
                                    <small class="text-muted">
                                        <i class="fas fa-user-tie me-1"></i>
                                        <strong>Class Teacher:</strong> <span id="class_teacher_name"></span>
                                    </small>
                                </div>
                                {% if form.school_class.help_text %}
                                    <div class="form-text">{{ form.school_class.help_text }}</div>
                                {% endif %}
                                {% if form.school_class.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.school_class.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Admission Date -->
                            <div class="col-md-4">
                                <label for="{{ form.admission_date.id_for_label }}" class="form-label">
                                    {{ form.admission_date.label }}
                                    {% if form.admission_date.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.admission_date }}
                                {% if form.admission_date.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.admission_date.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Parent Name -->
                            <div class="col-md-4">
                                <label for="{{ form.parent_name.id_for_label }}" class="form-label">
                                    {{ form.parent_name.label }}
                                    {% if form.parent_name.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.parent_name }}
                                {% if form.parent_name.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.parent_name.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Parent Phone -->
                            <div class="col-md-4">
                                <label for="{{ form.parent_phone.id_for_label }}" class="form-label">
                                    {{ form.parent_phone.label }}
                                    {% if form.parent_phone.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.parent_phone }}
                                {% if form.parent_phone.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.parent_phone.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Parent Email -->
                            <div class="col-md-4">
                                <label for="{{ form.parent_email.id_for_label }}" class="form-label">
                                    {{ form.parent_email.label }}
                                    {% if form.parent_email.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.parent_email }}
                                {% if form.parent_email.help_text %}
                                    <div class="form-text">{{ form.parent_email.help_text }}</div>
                                {% endif %}
                                {% if form.parent_email.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.parent_email.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Address -->
                            <div class="col-md-8">
                                <label for="{{ form.address.id_for_label }}" class="form-label">
                                    {{ form.address.label }}
                                    {% if form.address.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.address }}
                                {% if form.address.help_text %}
                                    <div class="form-text">{{ form.address.help_text }}</div>
                                {% endif %}
                                {% if form.address.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.address.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Transport Route -->
                            <div class="col-md-4">
                                <label for="{{ form.transport_route.id_for_label }}" class="form-label">
                                    {{ form.transport_route.label }}
                                    {% if form.transport_route.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                <select name="{{ form.transport_route.name }}" id="{{ form.transport_route.id_for_label }}" class="form-select">
                                    <option value="">None</option>
                                    {% for route in form.transport_route.field.queryset %}
                                        <option value="{{ route.id }}" 
                                                data-fare="{{ route.base_fare }}"
                                                {% if form.transport_route.value == route.id %}selected{% endif %}>
                                            {{ route.name }} (KES {{ route.base_fare|floatformat:2 }})
                                        </option>
                                    {% endfor %}
                                </select>
                                <div id="transport_route_info" class="mt-2" style="display: none;">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <strong>Route Fare:</strong> <span id="route_fare_display"></span>
                                    </small>
                                </div>
                                {% if form.transport_route.help_text %}
                                    <div class="form-text">{{ form.transport_route.help_text }}</div>
                                {% endif %}
                                {% if form.transport_route.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.transport_route.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Student Photo -->
                            <div class="col-md-6">
                                <label for="{{ form.photo.id_for_label }}" class="form-label">
                                    {{ form.photo.label }}
                                    {% if form.photo.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {% if student and student.photo %}
                                    <div class="mb-2">
                                        <img src="{{ student.photo.url }}" alt="Current photo" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                        <div class="form-text">Current photo</div>
                                    </div>
                                {% endif %}
                                {{ form.photo }}
                                {% if form.photo.help_text %}
                                    <div class="form-text">{{ form.photo.help_text }}</div>
                                {% endif %}
                                {% if form.photo.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.photo.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Optional Fee Categories -->
                            {% if form.optional_fee_categories.field.queryset %}
                            <div class="col-12">
                                <label class="form-label">Optional Fee Categories</label>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="row">
                                            {% for checkbox in form.optional_fee_categories %}
                                            <div class="col-md-6 mb-2">
                                                <div class="form-check">
                                                    {{ checkbox.tag }}
                                                    <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                                                        {{ checkbox.choice_label }}
                                                    </label>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <div class="form-text mt-2">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Select optional fee categories this student should pay. These fees will be applied when generating student fees.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Linked Parents -->
                            <div class="col-md-6">
                                <label for="{{ form.parents.id_for_label }}" class="form-label">
                                    Linked Parent Accounts
                                </label>
                                {{ form.parents }}
                                {% if form.parents.help_text %}
                                    <div class="form-text">{{ form.parents.help_text }}</div>
                                {% endif %}
                                {% if form.parents.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.parents.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'core:student_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> Back to Students
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> {% if student %}Update{% else %}Create{% endif %} Student
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Transport Route Change -->
{% if student %}
<div class="modal fade" id="transportRouteModal" tabindex="-1" aria-labelledby="transportRouteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="transportRouteModalLabel">
                    <i class="fas fa-route me-2"></i>Transport Route Changed
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You have changed the transport route for this student. Which terms should this change apply to?</p>
                <div class="mb-3">
                    <label class="form-label">Select Terms:</label>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="selectAllTerms" checked>
                        <label class="form-check-label" for="selectAllTerms">
                            <strong>Select All</strong>
                        </label>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 10px;">
                        {% for term in terms %}
                        <div class="form-check">
                            <input class="form-check-input term-checkbox" type="checkbox" 
                                   value="{{ term.id }}" 
                                   id="term_{{ term.id }}"
                                   data-term-id="{{ term.id }}"
                                   checked>
                            <label class="form-check-label" for="term_{{ term.id }}">
                                {{ term.academic_year }} - Term {{ term.term_number }}
                                {% if term.is_active %}<span class="badge bg-success ms-2">Active</span>{% endif %}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>Transport fees will be updated (or removed if route is cleared) for the selected terms.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmTransportChange">
                    <i class="fas fa-check me-2"></i>Apply to Selected Terms
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const gradeSelect = document.getElementById('{{ form.grade.id_for_label }}');
    const classSelect = document.getElementById('{{ form.school_class.id_for_label }}');
    
    if (gradeSelect && classSelect) {
        // Store all class options with their grade data
        const allClassOptions = [];
        const selectedClassValue = classSelect.value; // Store the currently selected value
        
        Array.from(classSelect.options).forEach(function(option) {
            if (option.value) {
                allClassOptions.push({
                    value: option.value,
                    text: option.text,
                    gradeId: option.getAttribute('data-grade-id') || null,
                    teacherName: option.getAttribute('data-teacher-name') || null,
                    teacherId: option.getAttribute('data-teacher-id') || null
                });
            }
        });
        
        // Get teacher display element
        const teacherDisplay = document.getElementById('class_teacher_display');
        const teacherNameSpan = document.getElementById('class_teacher_name');
        
        // Function to display teacher for selected class
        function displayClassTeacher(classOption) {
            if (classOption && classOption.teacherName) {
                teacherNameSpan.textContent = classOption.teacherName;
                teacherDisplay.style.display = 'block';
            } else {
                teacherDisplay.style.display = 'none';
            }
        }
        
        // Function to filter classes by grade
        function filterClassesByGrade(gradeId) {
            // Clear current options except the first one
            classSelect.innerHTML = '<option value="">---------</option>';
            
            if (gradeId) {
                // Filter and add classes for the selected grade
                allClassOptions.forEach(function(classOption) {
                    if (classOption.gradeId === gradeId) {
                        const option = document.createElement('option');
                        option.value = classOption.value;
                        option.textContent = classOption.text;
                        option.setAttribute('data-grade-id', classOption.gradeId);
                        if (classOption.teacherName) {
                            option.setAttribute('data-teacher-name', classOption.teacherName);
                            option.setAttribute('data-teacher-id', classOption.teacherId || '');
                        }
                        // Restore selected value if it matches
                        if (classOption.value === selectedClassValue) {
                            option.selected = true;
                            // Display teacher for initially selected class
                            displayClassTeacher(classOption);
                        }
                        classSelect.appendChild(option);
                    }
                });
            } else {
                // No grade selected, show all classes
                allClassOptions.forEach(function(classOption) {
                    const option = document.createElement('option');
                    option.value = classOption.value;
                    option.textContent = classOption.text;
                    option.setAttribute('data-grade-id', classOption.gradeId);
                    if (classOption.teacherName) {
                        option.setAttribute('data-teacher-name', classOption.teacherName);
                        option.setAttribute('data-teacher-id', classOption.teacherId || '');
                    }
                    // Restore selected value if it matches
                    if (classOption.value === selectedClassValue) {
                        option.selected = true;
                        // Display teacher for initially selected class
                        displayClassTeacher(classOption);
                    }
                    classSelect.appendChild(option);
                });
            }
        }
        
        // Add event listener for grade change
        gradeSelect.addEventListener('change', function() {
            filterClassesByGrade(this.value);
            // Clear teacher display when grade changes
            teacherDisplay.style.display = 'none';
        });
        
        // Add event listener for class change
        classSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.value) {
                // Get teacher info from the selected option's data attributes
                const teacherName = selectedOption.getAttribute('data-teacher-name');
                if (teacherName) {
                    teacherNameSpan.textContent = teacherName;
                    teacherDisplay.style.display = 'block';
                } else {
                    // Try to find in allClassOptions as fallback
                    const selectedClassData = allClassOptions.find(function(opt) {
                        return opt.value === selectedOption.value;
                    });
                    displayClassTeacher(selectedClassData);
                }
            } else {
                teacherDisplay.style.display = 'none';
            }
        });
        
        // Filter on page load if grade is already selected
        if (gradeSelect.value) {
            filterClassesByGrade(gradeSelect.value);
        }
        
        // Display teacher for initially selected class on page load
        if (classSelect.value) {
            const initialSelectedOption = classSelect.options[classSelect.selectedIndex];
            if (initialSelectedOption && initialSelectedOption.value) {
                const initialClassData = allClassOptions.find(function(opt) {
                    return opt.value === initialSelectedOption.value;
                });
                displayClassTeacher(initialClassData);
            }
        }
    }
    
    // Transport Route handling
    const transportRouteSelect = document.getElementById('{{ form.transport_route.id_for_label }}');
    const transportRouteInfo = document.getElementById('transport_route_info');
    const routeFareDisplay = document.getElementById('route_fare_display');
    const studentForm = document.getElementById('studentForm');
    const transportRouteModal = document.getElementById('transportRouteModal');
    const selectAllTerms = document.getElementById('selectAllTerms');
    const termCheckboxes = document.querySelectorAll('.term-checkbox');
    const termCheckboxesHidden = document.querySelectorAll('.term-checkbox-hidden');
    const confirmTransportChange = document.getElementById('confirmTransportChange');
    
    let originalRouteValue = transportRouteSelect ? transportRouteSelect.value : '';
    let modalConfirmed = false;
    
    if (transportRouteSelect) {
        // Function to update transport route info
        function updateTransportRouteInfo() {
            const selectedOption = transportRouteSelect.options[transportRouteSelect.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                const fare = selectedOption.getAttribute('data-fare');
                if (fare) {
                    routeFareDisplay.textContent = 'KES ' + parseFloat(fare).toFixed(2);
                    transportRouteInfo.style.display = 'block';
                } else {
                    transportRouteInfo.style.display = 'none';
                }
            } else {
                transportRouteInfo.style.display = 'none';
            }
        }
        
        // Add event listener for transport route change
        transportRouteSelect.addEventListener('change', updateTransportRouteInfo);
        
        // Update on page load if route is already selected
        if (transportRouteSelect.value) {
            updateTransportRouteInfo();
        }
    }
    
    // Handle transport route change prompt (only for existing students)
    {% if student %}
    if (transportRouteSelect && transportRouteModal && studentForm) {
        // Store original value on page load
        originalRouteValue = transportRouteSelect.value;
        let modalShownForRouteChange = false; // Track if modal was shown due to route change
        
        // Intercept form submission
        studentForm.addEventListener('submit', function(e) {
            const currentRouteValue = transportRouteSelect.value;
            
            // Check if transport route changed and modal hasn't been confirmed
            if (currentRouteValue !== originalRouteValue && !modalConfirmed) {
                e.preventDefault();
                e.stopPropagation();
                
                // Reset modal state
                modalConfirmed = false;
                modalShownForRouteChange = true; // Mark that modal is being shown for route change
                
                // Ensure all visible checkboxes are checked (they should be by default, but just in case)
                termCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = true;
                });
                if (selectAllTerms) {
                    selectAllTerms.checked = true;
                }
                
                // Sync checkboxes to default (all checked) before showing modal
                syncCheckboxes();
                
                // Debug: Log synced checkboxes (can be removed in production)
                // console.log('Modal shown. Synced checkboxes:', Array.from(termCheckboxesHidden).filter(cb => cb.checked).map(cb => cb.value));
                
                // Show modal
                const modal = new bootstrap.Modal(transportRouteModal);
                modal.show();
                
                return false;
            }
        });
        
        // Sync visible checkboxes with hidden checkboxes in form
        function syncCheckboxes() {
            let syncedCount = 0;
            termCheckboxes.forEach(function(visibleCheckbox) {
                const termId = visibleCheckbox.getAttribute('data-term-id');
                const hiddenCheckbox = document.getElementById('term_hidden_' + termId);
                if (hiddenCheckbox) {
                    hiddenCheckbox.checked = visibleCheckbox.checked;
                    syncedCount++;
                } else {
                    console.warn('Hidden checkbox not found for term:', termId);
                }
            });
            // Debug logging (can be removed in production)
            // console.log(`Synced ${syncedCount} checkboxes. Visible: ${termCheckboxes.length}, Hidden: ${termCheckboxesHidden.length}`);
            return syncedCount;
        }
        
        // Don't sync on page load - only sync when modal is shown or when user interacts
        
        // Handle "Select All" checkbox
        if (selectAllTerms) {
            selectAllTerms.addEventListener('change', function() {
                termCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = this.checked;
                }, this);
                syncCheckboxes();
            });
        }
        
        // Sync when individual checkboxes change
        termCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', syncCheckboxes);
        });
        
        // Handle confirm button
        if (confirmTransportChange) {
            confirmTransportChange.addEventListener('click', function() {
                // Check if at least one term is selected
                const selectedTerms = Array.from(termCheckboxes).filter(cb => cb.checked);
                
                if (selectedTerms.length === 0) {
                    alert('Please select at least one term, or cancel to proceed without updating transport fees.');
                    return;
                }
                
                // Sync checkboxes BEFORE closing modal
                syncCheckboxes();
                
                // Debug: Log selected terms before submit (can be removed in production)
                // const selectedHidden = Array.from(termCheckboxesHidden).filter(cb => cb.checked).map(cb => cb.value);
                // console.log('Confirm clicked. Selected terms:', selectedHidden);
                
                // Mark as confirmed
                modalConfirmed = true;
                modalShownForRouteChange = false; // Reset flag
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(transportRouteModal);
                modal.hide();
                
                // Submit the form after modal closes
                setTimeout(function() {
                    // Double-check sync before submitting - ensure all visible checked boxes sync to hidden
                    termCheckboxes.forEach(function(visibleCheckbox) {
                        if (visibleCheckbox.checked) {
                            const termId = visibleCheckbox.getAttribute('data-term-id');
                            const hiddenCheckbox = document.getElementById('term_hidden_' + termId);
                            if (hiddenCheckbox) {
                                hiddenCheckbox.checked = true;
                            }
                        }
                    });
                    
                    const finalSelected = Array.from(termCheckboxesHidden).filter(cb => cb.checked).map(cb => cb.value);
                    // Debug logging (can be removed in production)
                    // console.log('Final selected terms before submit:', finalSelected);
                    
                    // Verify checkboxes are in the form
                    const formCheckboxes = studentForm.querySelectorAll('input[name="apply_transport_to_terms"]:checked');
                    // console.log('Form checkboxes found:', formCheckboxes.length, Array.from(formCheckboxes).map(cb => cb.value));
                    
                    if (finalSelected.length === 0) {
                        console.error('ERROR: No terms selected! Checkboxes may not be syncing correctly.');
                        alert('Error: No terms were selected. Please try again.');
                        return;
                    }
                    
                    // Submit the form - modalConfirmed is true so submit handler won't intercept
                    if (studentForm.requestSubmit) {
                        studentForm.requestSubmit();
                    } else {
                        studentForm.submit();
                    }
                }, 300);
            });
        }
        
        // Handle modal cancel/close - reset route to original value if dismissed
        transportRouteModal.addEventListener('hidden.bs.modal', function() {
            // If modal was closed without confirming and it was shown for a route change
            if (!modalConfirmed && modalShownForRouteChange) {
                // Reset route to original value
                transportRouteSelect.value = originalRouteValue;
                // Trigger change event to update UI
                transportRouteSelect.dispatchEvent(new Event('change'));
                
                // Uncheck all terms
                termCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = false;
                });
                // Uncheck all hidden checkboxes
                termCheckboxesHidden.forEach(function(checkbox) {
                    checkbox.checked = false;
                });
                
                // Reset flags
                modalConfirmed = false;
                modalShownForRouteChange = false;
                
                // Do NOT submit the form - let user decide what to do next
            } else if (modalConfirmed) {
                // Modal was confirmed, so flags are already reset
                modalShownForRouteChange = false;
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}
