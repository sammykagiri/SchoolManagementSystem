{% extends 'base.html' %}
{% load permissions %}
{% load static %}

{% block title %}User Management | Eduvanta{% endblock %}

{% block extra_css %}
<style>
    .role-badge {
        font-size: 0.8rem;
        margin-right: 0.25rem;
    }
    .role-super_admin {
        background-color: #dc3545;
    }
    .role-school_admin {
        background-color: #0d6efd;
    }
    .role-teacher {
        background-color: #198754;
    }
    .role-accountant {
        background-color: #0dcaf0;
    }
    .role-parent {
        background-color: #ffc107;
        color: #000;
    }
    .role-student {
        background-color: #6c757d;
    }
    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    .status-active {
        background-color: #198754;
    }
    .status-inactive {
        background-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-users me-2"></i> User Management</h1>
        {% if user|has_permission:'add_user_management' %}
        <a href="{% url 'core:user_create' %}" class="btn btn-primary">
            <i class="fas fa-user-plus me-2"></i> Add New User
        </a>
        {% endif %}
    </div>
    
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-user-shield me-2"></i> System Users</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="usersTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>School</th>
                            <th>Roles</th>
                            <th>Status</th>
                            <th>Date Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for list_user in users %}
                        <tr>
                            <td>{{ list_user.username }}</td>
                            <td>{{ list_user.get_full_name|default:"—" }}</td>
                            <td>{{ list_user.email|default:"—" }}</td>
                            <td>{{ list_user.profile.school.name|default:"—" }}</td>
                            <td>
                                {% for role in list_user.profile.roles.all %}
                                    <span class="badge role-badge role-{{ role.name }}">
                                        {{ role.get_display_name }}
                                    </span>
                                {% empty %}
                                    <span class="badge bg-secondary">No roles assigned</span>
                                {% endfor %}
                            </td>
                            <td>
                                {% if list_user.is_active and list_user.profile.is_active %}
                                    <span class="status-indicator status-active"></span> Active
                                {% else %}
                                    <span class="status-indicator status-inactive"></span> Inactive
                                {% endif %}
                            </td>
                            <td>{{ list_user.date_joined|date:"d-m-Y" }}</td>
                            <td>
                                {% if is_superadmin %}
                                    {% if user|has_permission:'change_user_management' or user|has_permission:'delete_user_management' %}
                                    <div class="btn-group">
                                        {% if user|has_permission:'change_user_management' %}
                                        <a href="{% url 'core:user_edit' list_user.profile.get_signed_token %}" class="btn btn-sm btn-outline-primary action-btn" data-action="edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% endif %}
                                        {% if user|has_permission:'delete_user_management' %}
                                        <a href="{% url 'core:user_delete' list_user.profile.get_signed_token %}" class="btn btn-sm btn-outline-danger action-btn" data-action="delete">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                {% elif not list_user.is_superuser and not list_user.profile.is_super_admin %}
                                    {% if user|has_permission:'change_user_management' or user|has_permission:'delete_user_management' %}
                                    <div class="btn-group">
                                        {% if user|has_permission:'change_user_management' %}
                                        <a href="{% url 'core:user_edit' list_user.profile.get_signed_token %}" class="btn btn-sm btn-outline-primary action-btn" data-action="edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% endif %}
                                        {% if user|has_permission:'delete_user_management' %}
                                        <a href="{% url 'core:user_delete' list_user.profile.get_signed_token %}" class="btn btn-sm btn-outline-danger action-btn" data-action="delete">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                {% else %}
                                <span class="text-muted small">Protected</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center">No users found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';
    
    // Track clicked buttons to prevent double-clicks
    var clickedButtons = new Set();
    var clickTimeout = 500; // 500ms cooldown between clicks
    
    // Prevent double-clicking on action buttons
    $(document).on('click', '.action-btn', function(e) {
        var $btn = $(this);
        var btnId = $btn.attr('href') || $btn.data('action') + '-' + Math.random();
        
        // Check if this button was recently clicked
        if (clickedButtons.has(btnId)) {
            e.preventDefault();
            e.stopImmediatePropagation();
            return false;
        }
        
        // Mark as clicked
        clickedButtons.add(btnId);
        
        // Disable the button visually
        $btn.addClass('disabled').css('pointer-events', 'none').prop('disabled', true);
        
        // Remove from clicked set after timeout
        setTimeout(function() {
            clickedButtons.delete(btnId);
            $btn.removeClass('disabled').css('pointer-events', '').prop('disabled', false);
        }, clickTimeout);
    });
    
    // Initialize DataTables with optimized settings
    $(document).ready(function() {
        // Delay initialization to allow browser to complete initial render
        // Using setTimeout after requestAnimationFrame gives browser time to paint
        var initTable = function() {
            var table = $('#usersTable').DataTable({
                order: [[3, 'asc'], [0, 'asc']], // Sort by School (index 3), then Username (index 0)
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                responsive: false, // Disable responsive initially to avoid reflows
                deferRender: true, // Defer rendering for better performance
                processing: false, // Disable processing indicator to reduce reflows
                stateSave: false, // Disable state saving to reduce localStorage operations
                autoWidth: false, // Disable auto width calculation to prevent reflows
                scrollX: false, // Disable horizontal scroll to reduce calculations
                scrollCollapse: false, // Disable scroll collapse calculations
                pagingType: 'simple_numbers', // Lighter pagination type
                columnDefs: [
                    {
                        targets: [7], // Actions column
                        orderable: false, // Disable sorting on Actions column
                        searchable: false // Disable searching on Actions column
                    }
                ],
                language: {
                    search: "Filter:",
                    lengthMenu: "Show _MENU_ users per page",
                    info: "Showing _START_ to _END_ of _TOTAL_ users",
                    infoEmpty: "No users available",
                    infoFiltered: "(filtered from _MAX_ total users)",
                    zeroRecords: "No matching users found"
                }
            });
            
            // Store table reference for cleanup
            window.usersTable = table;
            
            // Enable responsive mode after initialization completes
            // This is done asynchronously to avoid blocking
            setTimeout(function() {
                if (table && table.responsive) {
                    try {
                        table.responsive.enable();
                    } catch (e) {
                        // Ignore errors if responsive is not available
                    }
                }
            }, 200);
        };
        
        // Use requestAnimationFrame followed by setTimeout to ensure
        // browser has time to paint before heavy initialization
        requestAnimationFrame(function() {
            setTimeout(initTable, 0);
        });
    });
    
    // Clean up on page unload
    $(window).on('beforeunload', function() {
        if (window.usersTable) {
            try {
                window.usersTable.destroy();
            } catch (e) {
                // Ignore errors during cleanup
            }
        }
    });
})();
</script>
{% endblock %}

