{% extends 'base.html' %}
{% load permissions %}
{% load static %}
{% load currency date_format %}

{% block title %}Student Detail - {{ student.first_name }} {{ student.last_name }}{% endblock %}

{% block extra_css %}
<style>
    /* Screen margins - only for student detail content */
    .student-detail-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px 30px;
    }
    
    @media print {
        @page {
            size: A4;
            margin: 2cm 1.5cm;
        }
        body {
            font-size: 11pt;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #000;
            background: #fff !important;
        }
        .student-detail-container {
            padding: 0 !important;
            max-width: 100% !important;
        }
        .card {
            border: 1px solid #ddd !important;
            box-shadow: none !important;
            margin-bottom: 15px;
            page-break-inside: avoid;
        }
        .card-header {
            background: #f8f9fa !important;
            color: #000 !important;
            border-bottom: 2px solid #ddd !important;
            padding: 10px 15px !important;
        }
        .table {
            font-size: 9pt;
            border-collapse: collapse;
        }
        .table th {
            background: #f8f9fa !important;
            color: #000 !important;
            font-weight: 600;
            border: 1px solid #ddd !important;
            padding: 6px 8px !important;
        }
        .table td {
            border: 1px solid #ddd !important;
            padding: 4px 6px !important;
        }
        .btn, .btn-group {
            display: none !important;
        }
        .badge {
            border: 1px solid #000;
            padding: 2px 6px;
        }
        img {
            max-width: 150px !important;
            max-height: 150px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid student-detail-container">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">{{ student.full_name }}</h3>
                    <div>
                        <button onclick="window.print()" class="btn btn-info">
                            <i class="fas fa-print"></i> Print
                        </button>
                        {% if user|has_permission:'change_student' %}
                        <a href="{% url 'core:student_update' student.student_id %}" class="btn btn-warning">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        {% endif %}
                        {% if user|has_permission:'delete_student' %}
                        <a href="{% url 'core:student_delete' student.student_id %}" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Delete
                        </a>
                        {% endif %}
                        <a href="{% url 'core:student_list' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to List
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Student Photo -->
                        <div class="col-md-3 text-center mb-4">
                            {% if student.photo %}
                                <img src="{{ student.photo.url }}" alt="{{ student.full_name }}" class="img-thumbnail rounded-circle" style="width: 200px; height: 200px; object-fit: cover;">
                            {% else %}
                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 200px; height: 200px; margin: 0 auto;">
                                    <i class="fas fa-user fa-5x text-muted"></i>
                                </div>
                            {% endif %}
                            <div class="mt-2">
                                <small class="text-muted">Student Photo</small>
                            </div>
                        </div>
                        
                        <div class="col-md-9">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Student Information:</h5>
                                    <table class="table table-borderless">
                                <tr>
                                    <th width="30%">Student ID:</th>
                                    <td>{{ student.student_id }}</td>
                                </tr>
                                <tr>
                                    <th>First Name:</th>
                                    <td>{{ student.first_name }}</td>
                                </tr>
                                <tr>
                                    <th>Middle Name:</th>
                                    <td>{{ student.middle_name|default:"â€”" }}</td>
                                </tr>
                                <tr>
                                    <th>Last Name:</th>
                                    <td>{{ student.last_name }}</td>
                                </tr>
                                <tr>
                                    <th>Date of Birth:</th>
                                    <td>{{ student.date_of_birth|indian_date }}</td>
                                </tr>
                                <tr>
                                    <th>Gender:</th>
                                    <td>{{ student.get_gender_display }}</td>
                                </tr>
                                <tr>
                                    <th>Grade:</th>
                                    <td>{{ student.grade.name }}</td>
                                </tr>
                                <tr>
                                    <th>Class:</th>
                                    <td>
                                        {% if student.school_class %}
                                            {{ student.school_class.name }}
                                            {% if student.school_class.class_teacher %}
                                                <br><small class="text-muted">Class Teacher: {{ student.school_class.class_teacher.full_name }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-danger fw-bold">
                                                <i class="fas fa-exclamation-triangle me-1"></i>Not Assigned
                                            </span>
                                            <br><small class="text-muted">Please assign a class to this student.</small>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Admission Date:</th>
                                    <td>{{ student.admission_date|indian_date }}</td>
                                </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h5>Contact Information:</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <th width="30%">Address:</th>
                                    <td>{{ student.address|default:"Not provided" }}</td>
                                </tr>
                                <tr>
                                    <th>UPI/NEMIS:</th>
                                    <td>{{ student.upi|default:"Not provided" }}</td>
                                </tr>
                                    </table>
                                    
                                    <h5 class="mt-4">Additional Information:</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <th width="30%">Status:</th>
                                    <td>
                                        <span class="badge bg-{% if student.is_active %}success{% else %}secondary{% endif %}">
                                            {% if student.is_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Created:</th>
                                    <td>{{ student.created_at|indian_datetime }}</td>
                                </tr>
                                <tr>
                                    <th>Last Updated:</th>
                                    <td>{{ student.updated_at|indian_datetime }}</td>
                                </tr>
                            </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Class Teacher Information -->
                    {% if student.school_class and student.school_class.class_teacher %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5><i class="fas fa-chalkboard-teacher me-2"></i>Class Teacher Information:</h5>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <table class="table table-borderless mb-0">
                                                <tr>
                                                    <th width="25%">Name:</th>
                                                    <td><strong>{{ student.school_class.class_teacher.full_name }}</strong></td>
                                                </tr>
                                                <tr>
                                                    <th>Employee ID:</th>
                                                    <td>{{ student.school_class.class_teacher.employee_id }}</td>
                                                </tr>
                                                {% if student.school_class.class_teacher.email %}
                                                <tr>
                                                    <th>Email:</th>
                                                    <td>
                                                        <a href="mailto:{{ student.school_class.class_teacher.email }}">{{ student.school_class.class_teacher.email }}</a>
                                                    </td>
                                                </tr>
                                                {% endif %}
                                                {% if student.school_class.class_teacher.phone %}
                                                <tr>
                                                    <th>Phone:</th>
                                                    <td>
                                                        <a href="tel:{{ student.school_class.class_teacher.phone }}">{{ student.school_class.class_teacher.phone }}</a>
                                                    </td>
                                                </tr>
                                                {% endif %}
                                                {% if student.school_class.class_teacher.qualification %}
                                                <tr>
                                                    <th>Qualification:</th>
                                                    <td>{{ student.school_class.class_teacher.qualification }}</td>
                                                </tr>
                                                {% endif %}
                                                {% if student.school_class.class_teacher.specialization %}
                                                <tr>
                                                    <th>Specialization:</th>
                                                    <td>{{ student.school_class.class_teacher.specialization }}</td>
                                                </tr>
                                                {% endif %}
                                            </table>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <div class="d-flex flex-column gap-2">
                                                {% if student.school_class.class_teacher.email %}
                                                <a href="mailto:{{ student.school_class.class_teacher.email }}" class="btn btn-primary">
                                                    <i class="fas fa-envelope me-2"></i>Send Email
                                                </a>
                                                {% endif %}
                                                {% if student.school_class.class_teacher.phone %}
                                                <a href="tel:{{ student.school_class.class_teacher.phone }}" class="btn btn-success">
                                                    <i class="fas fa-phone me-2"></i>Call
                                                </a>
                                                {% endif %}
                                                <a href="{% url 'core:teacher_detail' student.school_class.class_teacher.id %}" class="btn btn-outline-info">
                                                    <i class="fas fa-user-tie me-2"></i>View Profile
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Linked Parent Accounts -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5><i class="fas fa-users-cog me-2"></i>Linked Parent/Guardian Accounts:</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Username</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Preferred Contact</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for parent in student.parents.all %}
                                        <tr>
                                            <td><strong>{{ parent.full_name }}</strong></td>
                                            <td>{{ parent.user.username }}</td>
                                            <td>
                                                {% if parent.email %}
                                                    <a href="mailto:{{ parent.email }}">{{ parent.email }}</a>
                                                {% elif parent.user.email %}
                                                    <a href="mailto:{{ parent.user.email }}">{{ parent.user.email }}</a>
                                                {% else %}
                                                    <span class="text-muted">Not provided</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if parent.phone %}
                                                    <a href="tel:{{ parent.phone }}">{{ parent.phone }}</a>
                                                {% else %}
                                                    <span class="text-muted">Not provided</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">{{ parent.get_preferred_contact_method_display }}</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-{% if parent.is_active %}success{% else %}secondary{% endif %}">
                                                    {% if parent.is_active %}Active{% else %}Inactive{% endif %}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a href="{% url 'core:parent_detail' parent.id %}" class="btn btn-outline-info" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    {% if parent.email or parent.user.email %}
                                                    <a href="mailto:{{ parent.email|default:parent.user.email }}" class="btn btn-outline-primary" title="Send Email">
                                                        <i class="fas fa-envelope"></i>
                                                    </a>
                                                    {% endif %}
                                                    {% if parent.phone %}
                                                    <a href="tel:{{ parent.phone }}" class="btn btn-outline-success" title="Call">
                                                        <i class="fas fa-phone"></i>
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-muted text-center py-4">
                                                <i class="fas fa-info-circle me-2"></i>
                                                No linked parent accounts. You can link parents when editing the student profile.
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Communication Actions -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5>Communication Actions:</h5>
                            <div class="btn-group" role="group">
                                <a href="{% url 'communications:send_email' student.id %}" class="btn btn-primary">
                                    <i class="fas fa-envelope"></i> Send Email
                                </a>
                                <a href="{% url 'communications:send_sms' student.id %}" class="btn btn-success">
                                    <i class="fas fa-sms"></i> Send SMS
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Fee Details -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Fee Details:</h5>
                                <div>
                                    <span class="badge bg-info me-2">Total Charged: KES {{ total_charged|floatformat:2 }}</span>
                                    <span class="badge bg-success me-2">Total Paid: KES {{ total_paid|floatformat:2 }}</span>
                                    <span class="badge bg-{% if total_balance > 0 %}warning{% else %}secondary{% endif %}">Balance: KES {{ total_balance|floatformat:2 }}</span>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Term</th>
                                            <th>Fee Category</th>
                                            <th class="text-end">Amount Charged</th>
                                            <th class="text-end">Amount Paid</th>
                                            <th class="text-end">Balance</th>
                                            <th>Due Date</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for fee in student_fees %}
                                        <tr class="{% if fee.is_overdue and not fee.is_paid %}table-danger{% elif fee.is_paid %}table-success{% elif fee.balance > 0 %}table-warning{% endif %}" style="{% if fee.is_overdue and not fee.is_paid %}background-color: #f8d7da !important;{% elif fee.balance > 0 and not fee.is_paid %}background-color: #fff3cd !important;{% endif %}">
                                            <td>
                                                <strong>{{ fee.term.name }}</strong><br>
                                                <small class="text-muted">{{ fee.term.academic_year }}</small>
                                            </td>
                                            <td>{{ fee.fee_category.name }}</td>
                                            <td class="text-end">KES {{ fee.amount_charged|floatformat:2 }}</td>
                                            <td class="text-end">KES {{ fee.amount_paid|floatformat:2 }}</td>
                                            <td class="text-end">
                                                <strong class="{% if fee.balance > 0 %}text-danger fw-bold{% elif fee.balance < 0 %}text-success{% else %}text-muted{% endif %}" style="{% if fee.balance > 0 %}color: #dc3545 !important;{% endif %}">
                                                    KES {{ fee.balance|floatformat:2 }}
                                                </strong>
                                            </td>
                                            <td>
                                                {{ fee.due_date|indian_date }}
                                                {% if fee.is_overdue and not fee.is_paid %}
                                                    <br><small class="text-danger fw-bold"><i class="fas fa-exclamation-triangle"></i> Overdue</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if fee.is_paid %}
                                                    <span class="badge bg-success">Paid</span>
                                                {% elif fee.is_overdue %}
                                                    <span class="badge bg-danger">Overdue</span>
                                                {% elif fee.balance > 0 %}
                                                    <span class="badge" style="background-color: #fd7e14; color: white;">Pending</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">N/A</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center text-muted py-4">
                                                No fee records found for this student.
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Payment History -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5>Recent Payments:</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Method</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for payment in student.payment_set.all|slice:":5" %}
                                        <tr>
                                            <td>{{ payment.created_at|indian_date }}</td>
                                            <td>KES {{ payment.amount|floatformat:2 }}</td>
                                            <td>{{ payment.get_payment_method_display }}</td>
                                            <td>
                                                <span class="badge bg-{% if payment.status == 'completed' %}success{% elif payment.status == 'pending' %}warning{% else %}danger{% endif %}">
                                                    {{ payment.get_status_display }}
                                                </span>
                                            </td>
                                            <td>
                                                <a href="{% url 'payments:payment_detail' payment.id %}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center">No payments found.</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if student.payment_set.count > 5 %}
                            <div class="text-center mt-2">
                                <a href="{% url 'payments:payment_list' %}?student={{ student.student_id }}" class="btn btn-outline-primary">
                                    View All Payments
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
