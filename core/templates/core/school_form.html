{% extends 'base.html' %}
{% block title %}School Details | Eduvanta{% endblock %}
{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">School Details</h4>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    <form method="post" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="id_name" class="form-label">School Name</label>
                            <input type="text" name="name" id="id_name" class="form-control" value="{{ school.name }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="id_short_name" class="form-label">Short Name <span class="text-danger">*</span></label>
                            <input type="text" 
                                   name="short_name" 
                                   id="id_short_name" 
                                   class="form-control" 
                                   value="{{ school.short_name|default:'' }}" 
                                   pattern="^[a-zA-Z0-9]+([-._][a-zA-Z0-9]+)?$"
                                   title="One word or two words separated by dot (.), underscore (_), or hyphen (-). No spaces or other special characters."
                                   placeholder="e.g., ambassador, hip.hop, school-name, amb_assad"
                                   onkeypress="return /[a-zA-Z0-9\-._]/.test(event.key)"
                                   oninput="this.value = this.value.replace(/[^a-zA-Z0-9\-._]/g, '')"
                                   required>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Used in usernames (format: username@shortname). One word or two words separated by dot (.), underscore (_), or hyphen (-). No spaces or other special characters allowed.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="id_address" class="form-label">Address</label>
                            <input type="text" name="address" id="id_address" class="form-control" value="{{ school.address }}">
                        </div>
                        <div class="mb-3">
                            <label for="id_email" class="form-label">Email</label>
                            <input type="email" name="email" id="id_email" class="form-control" value="{{ school.email }}">
                        </div>
                        <div class="mb-3">
                            <label for="id_phone" class="form-label">Phone</label>
                            <input type="text" name="phone" id="id_phone" class="form-control" value="{{ school.phone }}">
                        </div>
                        <div class="mb-3">
                            <label for="id_logo" class="form-label">School Logo</label>
                            <input type="file" name="logo" id="id_logo" class="form-control">
                            {% if school.logo %}
                                <div class="mt-2">
                                    <img src="{{ school.logo.url }}" alt="School Logo" style="max-height: 80px;">
                                </div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">School Color Scheme</label>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <label for="id_primary_color" class="form-label small mb-0">Primary Color</label>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="reset_primary_color" title="Reset to default color">
                                        <i class="fas fa-undo me-1"></i>Reset to Default
                                    </button>
                                </div>
                                <div class="input-group">
                                    <input type="color" 
                                           name="primary_color" 
                                           id="id_primary_color" 
                                           class="form-control form-control-color" 
                                           value="{% if school.primary_color %}{{ school.primary_color }}{% else %}#0d6efd{% endif %}"
                                           title="Choose primary color">
                                    <input type="text" 
                                           id="id_primary_color_text" 
                                           class="form-control" 
                                           value="{% if school.primary_color %}{{ school.primary_color }}{% else %}#0d6efd{% endif %}"
                                           placeholder="#0d6efd"
                                           pattern="^#[0-9A-Fa-f]{6}$"
                                           maxlength="7">
                                </div>
                                <div class="form-text small">Primary color for buttons and primary elements (Default: #0d6efd)</div>
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <label for="id_secondary_color" class="form-label small mb-0">Secondary Color (Optional)</label>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="reset_secondary_color" title="Reset to default color">
                                        <i class="fas fa-undo me-1"></i>Reset to Default
                                    </button>
                                </div>
                                <div class="input-group">
                                    <input type="color" 
                                           name="secondary_color" 
                                           id="id_secondary_color" 
                                           class="form-control form-control-color" 
                                           value="{% if school.secondary_color %}{{ school.secondary_color }}{% else %}#6c757d{% endif %}"
                                           title="Choose secondary color">
                                    <input type="text" 
                                           id="id_secondary_color_text" 
                                           class="form-control" 
                                           value="{% if school.secondary_color %}{{ school.secondary_color }}{% else %}#6c757d{% endif %}"
                                           placeholder="#6c757d"
                                           pattern="^#[0-9A-Fa-f]{6}$"
                                           maxlength="7">
                                </div>
                                <div class="form-text small">Secondary color for accents and optional header styling (Default: #6c757d)</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input type="checkbox" 
                                       name="use_color_scheme" 
                                       id="id_use_color_scheme" 
                                       class="form-check-input" 
                                       {% if school.use_color_scheme %}checked{% endif %}>
                                <label class="form-check-label" for="id_use_color_scheme">
                                    Apply this color scheme to the application
                                </label>
                            </div>
                            <div class="form-text">When enabled, the selected colors will be used throughout the application.</div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input type="checkbox" 
                                       name="use_secondary_on_headers" 
                                       id="id_use_secondary_on_headers" 
                                       class="form-check-input" 
                                       {% if school.use_secondary_on_headers %}checked{% endif %}>
                                <label class="form-check-label" for="id_use_secondary_on_headers">
                                    Apply secondary color to headers
                                </label>
                            </div>
                            <div class="form-text">When enabled, the secondary color will be applied to card headers and section headers.</div>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'core:school_admin_list' %}" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Update School</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const colorPicker = document.getElementById('id_primary_color');
        const colorText = document.getElementById('id_primary_color_text');
        const secondaryColorPicker = document.getElementById('id_secondary_color');
        const secondaryColorText = document.getElementById('id_secondary_color_text');
        const useColorScheme = document.getElementById('id_use_color_scheme');
        const useSecondaryOnHeaders = document.getElementById('id_use_secondary_on_headers');
        
        // Function to update color scheme preview
        function updateColorSchemePreview(primaryColor, secondaryColor) {
            if (!primaryColor || !/^#[0-9A-Fa-f]{6}$/.test(primaryColor)) {
                return;
            }
            
            // Only update if checkbox is checked
            if (useColorScheme && !useColorScheme.checked) {
                return;
            }
            
            // Update CSS variables
            document.documentElement.style.setProperty('--bs-primary', primaryColor);
            if (secondaryColor && /^#[0-9A-Fa-f]{6}$/.test(secondaryColor)) {
                document.documentElement.style.setProperty('--bs-secondary', secondaryColor);
            }
            
            // Update all primary elements
            const style = document.createElement('style');
            style.id = 'dynamic-color-scheme';
            
            // Remove existing dynamic style if any
            const existingStyle = document.getElementById('dynamic-color-scheme');
            if (existingStyle) {
                existingStyle.remove();
            }
            
            let styleContent = `
                .bg-primary {
                    background-color: ${primaryColor} !important;
                }
                .btn-primary {
                    background-color: ${primaryColor};
                    border-color: ${primaryColor};
                }
                .btn-primary:hover,
                .btn-primary:focus,
                .btn-primary:active {
                    background-color: ${primaryColor};
                    border-color: ${primaryColor};
                    filter: brightness(0.9);
                }
                .text-primary {
                    color: ${primaryColor} !important;
                }
                .border-primary {
                    border-color: ${primaryColor} !important;
                }
                .btn-outline-primary {
                    color: ${primaryColor};
                    border-color: ${primaryColor};
                }
                .btn-outline-primary:hover,
                .btn-outline-primary:focus,
                .btn-outline-primary:active {
                    background-color: ${primaryColor};
                    border-color: ${primaryColor};
                    color: #fff;
                }
                .alert-primary {
                    background-color: ${primaryColor};
                    border-color: ${primaryColor};
                    color: #fff;
                }
                .badge.bg-primary {
                    background-color: ${primaryColor} !important;
                }
                a.text-primary:hover,
                a.text-primary:focus {
                    color: ${primaryColor} !important;
                }
            `;
            
            // Add secondary color styles if provided
            if (secondaryColor && /^#[0-9A-Fa-f]{6}$/.test(secondaryColor)) {
                styleContent += `
                    .bg-secondary {
                        background-color: ${secondaryColor} !important;
                    }
                `;
                
                // Apply to headers if checkbox is checked
                if (useSecondaryOnHeaders && useSecondaryOnHeaders.checked) {
                    styleContent += `
                        .card-header.bg-primary {
                            background-color: ${secondaryColor} !important;
                        }
                        h1, h2, h3, h4, h5, h6,
                        .card-title, .card-title h1, .card-title h2, .card-title h3, .card-title h4, .card-title h5, .card-title h6,
                        .title, .page-title, .section-title {
                            color: ${secondaryColor} !important;
                        }
                    `;
                }
            }
            
            style.textContent = styleContent;
            document.head.appendChild(style);
        }
        
        // Function to remove color scheme preview
        function removeColorSchemePreview() {
            const existingStyle = document.getElementById('dynamic-color-scheme');
            if (existingStyle) {
                existingStyle.remove();
            }
            document.documentElement.style.removeProperty('--bs-primary');
        }
        
        // Helper function to get current colors
        function getCurrentColors() {
            const primary = colorPicker ? colorPicker.value : '';
            const secondary = secondaryColorPicker ? secondaryColorPicker.value : '';
            return { primary, secondary };
        }
        
        // Sync color picker with text input and update preview
        if (colorPicker && colorText) {
            colorPicker.addEventListener('input', function() {
                const color = colorPicker.value;
                colorText.value = color;
                if (useColorScheme && useColorScheme.checked) {
                    const colors = getCurrentColors();
                    updateColorSchemePreview(colors.primary, colors.secondary);
                }
            });
            
            colorText.addEventListener('input', function() {
                const value = colorText.value.trim();
                // Validate hex color format
                if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                    colorPicker.value = value;
                    if (useColorScheme && useColorScheme.checked) {
                        const colors = getCurrentColors();
                        updateColorSchemePreview(colors.primary, colors.secondary);
                    }
                }
            });
            
            colorText.addEventListener('blur', function() {
                const value = colorText.value.trim();
                // If invalid format, reset to picker value
                if (!/^#[0-9A-Fa-f]{6}$/.test(value)) {
                    colorText.value = colorPicker.value;
                }
            });
        }
        
        // Sync secondary color picker with text input and update preview
        if (secondaryColorPicker && secondaryColorText) {
            secondaryColorPicker.addEventListener('input', function() {
                const color = secondaryColorPicker.value;
                secondaryColorText.value = color;
                if (useColorScheme && useColorScheme.checked) {
                    const colors = getCurrentColors();
                    updateColorSchemePreview(colors.primary, colors.secondary);
                }
            });
            
            secondaryColorText.addEventListener('input', function() {
                const value = secondaryColorText.value.trim();
                // Validate hex color format
                if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                    secondaryColorPicker.value = value;
                    if (useColorScheme && useColorScheme.checked) {
                        const colors = getCurrentColors();
                        updateColorSchemePreview(colors.primary, colors.secondary);
                    }
                }
            });
            
            secondaryColorText.addEventListener('blur', function() {
                const value = secondaryColorText.value.trim();
                // If invalid format, reset to picker value
                if (!/^#[0-9A-Fa-f]{6}$/.test(value)) {
                    secondaryColorText.value = secondaryColorPicker.value;
                }
            });
        }
        
        // Handle checkbox changes
        if (useColorScheme) {
            useColorScheme.addEventListener('change', function() {
                if (this.checked && colorPicker) {
                    const colors = getCurrentColors();
                    updateColorSchemePreview(colors.primary, colors.secondary);
                } else {
                    removeColorSchemePreview();
                }
            });
            
            // Initialize preview if checkbox is checked on load
            if (useColorScheme.checked && colorPicker) {
                const colors = getCurrentColors();
                updateColorSchemePreview(colors.primary, colors.secondary);
            }
        }
        
        // Handle secondary on headers checkbox
        if (useSecondaryOnHeaders) {
            useSecondaryOnHeaders.addEventListener('change', function() {
                if (useColorScheme && useColorScheme.checked && colorPicker) {
                    const colors = getCurrentColors();
                    updateColorSchemePreview(colors.primary, colors.secondary);
                }
            });
        }
        
        // Reset to default colors functionality
        const resetPrimaryColor = document.getElementById('reset_primary_color');
        const resetSecondaryColor = document.getElementById('reset_secondary_color');
        const DEFAULT_PRIMARY_COLOR = '#0d6efd';
        const DEFAULT_SECONDARY_COLOR = '#6c757d';
        
        if (resetPrimaryColor && colorPicker && colorText) {
            resetPrimaryColor.addEventListener('click', function() {
                colorPicker.value = DEFAULT_PRIMARY_COLOR;
                colorText.value = DEFAULT_PRIMARY_COLOR;
                // Update preview if color scheme is enabled
                if (useColorScheme && useColorScheme.checked) {
                    const colors = getCurrentColors();
                    updateColorSchemePreview(colors.primary, colors.secondary);
                }
            });
        }
        
        if (resetSecondaryColor && secondaryColorPicker && secondaryColorText) {
            resetSecondaryColor.addEventListener('click', function() {
                secondaryColorPicker.value = DEFAULT_SECONDARY_COLOR;
                secondaryColorText.value = DEFAULT_SECONDARY_COLOR;
                // Update preview if color scheme is enabled
                if (useColorScheme && useColorScheme.checked) {
                    const colors = getCurrentColors();
                    updateColorSchemePreview(colors.primary, colors.secondary);
                }
            });
        }
    });
</script>
{% endblock %}
