{% load static %}
{% load permissions %}

<!-- Sidebar -->
<aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
        {% if user.is_authenticated and user.profile and user.profile.school and user.profile.school.logo %}
            {% if not user.is_superuser and user|has_permission:'view_parent_portal' %}
            <a href="{% url 'core:parent_portal_dashboard' %}" class="school-logo-container mb-2" style="display: block; text-decoration: none; cursor: pointer;">
                <img src="{{ user.profile.school.logo.url }}" alt="School Logo" class="school-logo">
            </a>
            {% else %}
            <a href="{% url 'core:home' %}" class="school-logo-container mb-2" style="display: block; text-decoration: none; cursor: pointer;">
                <img src="{{ user.profile.school.logo.url }}" alt="School Logo" class="school-logo">
            </a>
            {% endif %}
        {% endif %}
        {% if not user.is_superuser and user|has_permission:'view_parent_portal' %}
        <a href="{% url 'core:parent_portal_dashboard' %}" class="sidebar-brand">
            {% if user.is_authenticated and user.profile and user.profile.school %}
                {{ user.profile.school.name|title }}
            {% else %}
                School Management
            {% endif %}
        </a>
        {% else %}
        <a href="{% url 'core:home' %}" class="sidebar-brand">
            {% if user.is_authenticated and user.profile and user.profile.school %}
                {{ user.profile.school.name|title }}
            {% else %}
                School Management
            {% endif %}
        </a>
        {% endif %}
    </div>
    
    <nav class="sidebar-nav flex-grow-1">
        {% if user.is_authenticated %}
            {% if user.is_superuser or user.profile %}
                {% if user.is_superuser or not user.profile.is_student %}
                    {% if user.is_superuser or not user.profile.is_parent %}
                    {% comment %}Check if user has school assigned - show all menus only if user has school{% endcomment %}
                    {% if user.is_superuser or user.profile and user.profile.school %}
        <ul class="nav flex-column">
            <!-- Home -->
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'core:home' %}">
                    <i class="fas fa-home me-2"></i>
                    <span>Home</span>
                </a>
            </li>
            
            <!-- Dashboard -->
            {% if user|has_permission:'view_dashboard' %}
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" href="{% url 'core:dashboard' %}">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            {% endif %}
            
            <!-- Students -->
            {% if user|has_permission:'view_student' or user|has_permission:'add_student' %}
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'student_list' or request.resolver_match.url_name == 'student_detail' or request.resolver_match.url_name == 'student_create' or request.resolver_match.url_name == 'student_update' or 'promotion' in request.resolver_match.url_name %}active{% endif %}" 
                   href="#" data-bs-toggle="collapse" data-bs-target="#studentsSubmenu" aria-expanded="false">
                    <i class="fas fa-users me-2"></i>
                    <span>Students</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <ul class="collapse nav flex-column submenu" id="studentsSubmenu">
                    {% if user|has_permission:'view_student' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'student_list' %}active{% endif %}" href="{% url 'core:student_list' %}">
                            <i class="fas fa-list me-2"></i>Student List
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'add_student' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'student_create' or request.resolver_match.url_name == 'student_detail' or request.resolver_match.url_name == 'student_update' %}active{% endif %}" href="{% url 'core:student_create' %}" id="addStudentNavLink">
                            <i class="fas fa-plus me-2"></i>Add Student
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'change_student' %}
                    <li class="nav-item"><hr class="dropdown-divider my-2"></li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'promotion' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'core:promotion_wizard_step1' %}">
                            <i class="fas fa-graduation-cap me-2"></i>Student Promotion
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'promotion_history' %}active{% endif %}" href="{% url 'core:promotion_history' %}">
                            <i class="fas fa-history me-2"></i>Promotion History
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </li>
            {% endif %}
            
            <!-- Parents -->
            {% if user|has_permission:'view_parent' or user|has_permission:'add_parent' %}
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'parent_list' or request.resolver_match.url_name == 'parent_detail' or request.resolver_match.url_name == 'parent_register' %}active{% endif %}" 
                   href="#" data-bs-toggle="collapse" data-bs-target="#parentsSubmenu" aria-expanded="false">
                    <i class="fas fa-user-friends me-2"></i>
                    <span>Parents</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <ul class="collapse nav flex-column submenu" id="parentsSubmenu">
                    {% if user|has_permission:'view_parent' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'parent_list' %}active{% endif %}" href="{% url 'core:parent_list' %}">
                            <i class="fas fa-list me-2"></i>Parent List
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'add_parent' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'parent_register' %}active{% endif %}" href="{% url 'core:parent_register' %}">
                            <i class="fas fa-plus me-2"></i>Add Parent
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </li>
            {% endif %}
            
            <!-- Teachers -->
            {% if user|has_permission:'view_teacher' or user|has_permission:'add_teacher' %}
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'teacher_list' or request.resolver_match.url_name == 'teacher_add' or request.resolver_match.url_name == 'teacher_edit' or request.resolver_match.url_name == 'teacher_detail' %}active{% endif %}" 
                   href="#" data-bs-toggle="collapse" data-bs-target="#teachersSubmenu" aria-expanded="false">
                    <i class="fas fa-user-tie me-2"></i>
                    <span>Teachers</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <ul class="collapse nav flex-column submenu" id="teachersSubmenu">
                    {% if user|has_permission:'view_teacher' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'teacher_list' or request.resolver_match.url_name == 'teacher_detail' %}active{% endif %}" href="{% url 'core:teacher_list' %}">
                            <i class="fas fa-list me-2"></i>Teacher List
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'add_teacher' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'teacher_add' or request.resolver_match.url_name == 'teacher_edit' %}active{% endif %}" href="{% url 'core:teacher_add' %}">
                            <i class="fas fa-plus me-2"></i>Add Teacher
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </li>
            {% endif %}
            
            <!-- Fees -->
            {% if user|has_permission:'view_fee' or user|has_permission:'view_fee_structure' or user|has_permission:'view_payment' or user|has_permission:'view_receipt' %}
            <li class="nav-item">
                <a class="nav-link {% if 'payments' in request.resolver_match.namespace or request.resolver_match.url_name == 'fee_structure_list' or request.resolver_match.url_name == 'generate_student_fees' or request.resolver_match.url_name == 'fee_category_list' or request.resolver_match.url_name == 'fee_category_type_list' %}active{% endif %}" 
                   href="#" data-bs-toggle="collapse" data-bs-target="#feesSubmenu" aria-expanded="false">
                    <i class="fas fa-money-bill-wave me-2"></i>
                    <span>Fees</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <ul class="collapse nav flex-column submenu" id="feesSubmenu">
                    {% if user|has_permission:'view_fee' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'fee_category_type_list' or request.resolver_match.url_name == 'fee_category_type_add' or request.resolver_match.url_name == 'fee_category_type_edit' %}active{% endif %}" href="{% url 'core:fee_category_type_list' %}">
                            <i class="fas fa-tag me-2"></i>Category Types
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'fee_category_list' or request.resolver_match.url_name == 'fee_category_create' or request.resolver_match.url_name == 'fee_category_edit' %}active{% endif %}" href="{% url 'core:fee_category_list' %}">
                            <i class="fas fa-tags me-2"></i>Fee Categories
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_fee_structure' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'fee_structure_list' or request.resolver_match.url_name == 'fee_structure_create' or request.resolver_match.url_name == 'fee_structure_update' or request.resolver_match.url_name == 'fee_structure_delete' %}active{% endif %}" href="{% url 'core:fee_structure_list' %}">
                            <i class="fas fa-list-alt me-2"></i>Fee Structures
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'add_fee' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'generate_student_fees' %}active{% endif %}" href="{% url 'core:generate_student_fees' %}">
                            <i class="fas fa-cogs me-2"></i>Generate Fees
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_fee' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'fee_summary' %}active{% endif %}" href="{% url 'payments:fee_summary' %}">
                            <i class="fas fa-file-invoice-dollar me-2"></i>Fee Summary
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_payment' or user|has_permission:'view_receipt' or user|has_permission:'view_reminder' %}
                    <li class="nav-item"><hr class="dropdown-divider my-2"></li>
                    {% if user|has_permission:'view_payment' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'payment_list' or request.resolver_match.url_name == 'payment_detail' or request.resolver_match.url_name == 'payment_create' %}active{% endif %}" href="{% url 'payments:payment_list' %}">
                            <i class="fas fa-credit-card me-2"></i>Payments
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_receipt' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'receipt_list' or request.resolver_match.url_name == 'receipt_detail' %}active{% endif %}" href="{% url 'payments:receipt_list' %}">
                            <i class="fas fa-receipt me-2"></i>Receipts
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_reminder' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'reminder_list' or request.resolver_match.url_name == 'reminder_create' %}active{% endif %}" href="{% url 'payments:reminder_list' %}">
                            <i class="fas fa-bell me-2"></i>Reminders
                        </a>
                    </li>
                    {% endif %}
                    {% endif %}
                </ul>
            </li>
            {% endif %}
            
            <!-- Attendance -->
            {% if user|has_permission:'view_attendance' or user|has_permission:'add_attendance' %}
            <li class="nav-item">
                <a class="nav-link {% if 'attendance' in request.resolver_match.namespace %}active{% endif %}" 
                   href="#" data-bs-toggle="collapse" data-bs-target="#attendanceSubmenu" aria-expanded="false">
                    <i class="fas fa-check-circle me-2"></i>
                    <span>Attendance</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <ul class="collapse nav flex-column submenu" id="attendanceSubmenu">
                    {% if user|has_permission:'view_attendance' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'attendance_list' or request.resolver_match.url_name == 'attendance_detail' %}active{% endif %}" href="{% url 'attendance:attendance_list' %}">
                            <i class="fas fa-list me-2"></i>Attendance Records
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'add_attendance' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'mark_attendance' %}active{% endif %}" href="{% url 'attendance:mark_attendance' %}">
                            <i class="fas fa-edit me-2"></i>Mark Attendance
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_attendance' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'attendance_summary' %}active{% endif %}" href="{% url 'attendance:attendance_summary' %}">
                            <i class="fas fa-chart-bar me-2"></i>Summary
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </li>
            {% endif %}
            
            <!-- Subjects -->
            {% if user|has_permission:'view_subject' or user|has_permission:'add_subject' %}
            <li class="nav-item">
                <a class="nav-link {% if 'subject' in request.resolver_match.url_name or 'subject' in request.resolver_match.namespace %}active{% endif %}" 
                   href="#" data-bs-toggle="collapse" data-bs-target="#subjectsSubmenu" aria-expanded="false">
                    <i class="fas fa-book-open me-2"></i>
                    <span>Subjects</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <ul class="collapse nav flex-column submenu" id="subjectsSubmenu">
                    {% if user|has_permission:'view_subject' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'subject_list' or request.resolver_match.url_name == 'subject_detail' %}active{% endif %}" href="{% url 'timetable:subject_list' %}">
                            <i class="fas fa-list me-2"></i>Subject List
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'subject_level_overview' %}active{% endif %}" href="{% url 'timetable:subject_level_overview' %}">
                            <i class="fas fa-layer-group me-2"></i>View by Level
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'add_subject' or user|has_permission:'change_subject' %}
                    <li class="nav-item"><hr class="dropdown-divider my-2"></li>
                    {% if user|has_permission:'add_subject' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'subject_add' or request.resolver_match.url_name == 'subject_edit' %}active{% endif %}" href="{% url 'timetable:subject_add' %}">
                            <i class="fas fa-plus me-2"></i>Add Subject
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'subject_generate' %}active{% endif %}" href="{% url 'timetable:subject_generate' %}">
                            <i class="fas fa-magic me-2"></i>Generate CBC Subjects
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'change_subject' %}
                    <li class="nav-item"><hr class="dropdown-divider my-2"></li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'subject_bulk_update_level' %}active{% endif %}" href="{% url 'timetable:subject_bulk_update_level' %}">
                            <i class="fas fa-edit me-2"></i>Bulk Update Levels
                        </a>
                    </li>
                    {% endif %}
                    {% endif %}
                </ul>
            </li>
            {% endif %}
            
            <!-- Timetable -->
            {% if user|has_permission:'view_timetable' or user|has_permission:'add_timetable' %}
            <li class="nav-item">
                <a class="nav-link {% if 'timetable' in request.resolver_match.namespace and request.resolver_match.url_name != 'subject_list' and request.resolver_match.url_name != 'subject_add' %}active{% endif %}" 
                   href="#" data-bs-toggle="collapse" data-bs-target="#timetableSubmenu" aria-expanded="false">
                    <i class="fas fa-calendar-week me-2"></i>
                    <span>Timetable</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <ul class="collapse nav flex-column submenu" id="timetableSubmenu">
                    {% if user|has_permission:'view_timetable' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'timetable_list' or request.resolver_match.url_name == 'timetable_detail' or request.resolver_match.url_name == 'timetable_create' or request.resolver_match.url_name == 'timetable_edit' %}active{% endif %}" href="{% url 'timetable:timetable_list' %}">
                            <i class="fas fa-calendar me-2"></i>Class Timetables
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'add_timetable' or user|has_permission:'change_timetable' %}
                    <li class="nav-item"><hr class="dropdown-divider my-2"></li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'timeslot_list' or request.resolver_match.url_name == 'timeslot_create' or request.resolver_match.url_name == 'timeslot_edit' %}active{% endif %}" href="{% url 'timetable:timeslot_list' %}">
                            <i class="fas fa-clock me-2"></i>Time Slots
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </li>
            {% endif %}
            
            <!-- Exams -->
            {% if user|has_permission:'view_exam' or user|has_permission:'view_gradebook' %}
            <li class="nav-item">
                <a class="nav-link {% if 'exams' in request.resolver_match.namespace %}active{% endif %}" 
                   href="#" data-bs-toggle="collapse" data-bs-target="#examsSubmenu" aria-expanded="false">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <span>Exams</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <ul class="collapse nav flex-column submenu" id="examsSubmenu">
                    {% if user|has_permission:'view_exam' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'exam_list' or request.resolver_match.url_name == 'exam_detail' or request.resolver_match.url_name == 'exam_create' or request.resolver_match.url_name == 'exam_edit' %}active{% endif %}" href="{% url 'exams:exam_list' %}">
                            <i class="fas fa-file-alt me-2"></i>Exams
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_gradebook' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'gradebook_list' or request.resolver_match.url_name == 'gradebook_detail' %}active{% endif %}" href="{% url 'exams:gradebook_list' %}">
                            <i class="fas fa-book me-2"></i>Gradebook
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'gradebook_summary_list' or request.resolver_match.url_name == 'gradebook_summary_detail' %}active{% endif %}" href="{% url 'exams:gradebook_summary_list' %}">
                            <i class="fas fa-chart-bar me-2"></i>Summary
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </li>
            {% endif %}
            
            <!-- Homework -->
            {% if user|has_permission:'view_assignment' or user|has_permission:'view_submission' %}
            <li class="nav-item">
                <a class="nav-link {% if 'homework' in request.resolver_match.namespace %}active{% endif %}" 
                   href="#" data-bs-toggle="collapse" data-bs-target="#homeworkSubmenu" aria-expanded="false">
                    <i class="fas fa-book me-2"></i>
                    <span>Homework</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <ul class="collapse nav flex-column submenu" id="homeworkSubmenu">
                    {% if user|has_permission:'view_assignment' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'assignment_list' or request.resolver_match.url_name == 'assignment_detail' or request.resolver_match.url_name == 'assignment_create' or request.resolver_match.url_name == 'assignment_edit' %}active{% endif %}" href="{% url 'homework:assignment_list' %}">
                            <i class="fas fa-list me-2"></i>Assignments
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_submission' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'submission_list' or request.resolver_match.url_name == 'submission_detail' %}active{% endif %}" href="{% url 'homework:submission_list' %}">
                            <i class="fas fa-check-circle me-2"></i>View Submissions
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </li>
            {% endif %}
            
            <!-- Communications -->
            {% if user|has_permission:'view_template' or user|has_permission:'view_email' or user|has_permission:'view_sms' or user|has_permission:'view_log' %}
            <li class="nav-item">
                <a class="nav-link {% if 'communications' in request.resolver_match.namespace %}active{% endif %}" 
                   href="#" data-bs-toggle="collapse" data-bs-target="#communicationsSubmenu" aria-expanded="false">
                    <i class="fas fa-envelope me-2"></i>
                    <span>Communications</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <ul class="collapse nav flex-column submenu" id="communicationsSubmenu">
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' and 'communications' in request.resolver_match.namespace %}active{% endif %}" href="{% url 'communications:dashboard' %}">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                        </a>
                    </li>
                    {% if user|has_permission:'view_template' or user|has_permission:'view_email' or user|has_permission:'view_sms' or user|has_permission:'view_log' %}
                    <li class="nav-item"><hr class="dropdown-divider my-2"></li>
                    {% if user|has_permission:'view_template' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'template_list' or request.resolver_match.url_name == 'template_create' or request.resolver_match.url_name == 'template_edit' %}active{% endif %}" href="{% url 'communications:template_list' %}">
                            <i class="fas fa-file-alt me-2"></i>Templates
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_email' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'email_list' or request.resolver_match.url_name == 'email_detail' or request.resolver_match.url_name == 'email_send' %}active{% endif %}" href="{% url 'communications:email_list' %}">
                            <i class="fas fa-envelope me-2"></i>Emails
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_sms' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'sms_list' or request.resolver_match.url_name == 'sms_detail' or request.resolver_match.url_name == 'sms_send' %}active{% endif %}" href="{% url 'communications:sms_list' %}">
                            <i class="fas fa-sms me-2"></i>SMS Messages
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_log' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'log_list' or request.resolver_match.url_name == 'log_detail' %}active{% endif %}" href="{% url 'communications:log_list' %}">
                            <i class="fas fa-list me-2"></i>Communication Logs
                        </a>
                    </li>
                    {% endif %}
                    {% endif %}
                </ul>
            </li>
            {% endif %}
            
            <!-- Reports -->
            {% if user|has_permission:'view_report' %}
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'financial_reports' or request.resolver_match.url_name == 'payment_collection_report' or request.resolver_match.url_name == 'outstanding_fees_report' or request.resolver_match.url_name == 'collection_summary_report' or request.resolver_match.url_name == 'payment_method_analysis' %}active{% endif %}" 
                   href="#" data-bs-toggle="collapse" data-bs-target="#reportsSubmenu" aria-expanded="false">
                    <i class="fas fa-chart-line me-2"></i>
                    <span>Reports</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <ul class="collapse nav flex-column submenu" id="reportsSubmenu">
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'financial_reports' or request.resolver_match.url_name == 'payment_collection_report' or request.resolver_match.url_name == 'outstanding_fees_report' or request.resolver_match.url_name == 'collection_summary_report' or request.resolver_match.url_name == 'payment_method_analysis' %}active{% endif %}" href="{% url 'payments:financial_reports' %}">
                            <i class="fas fa-file-invoice-dollar me-2"></i>Financial Reports
                        </a>
                    </li>
                </ul>
            </li>
            {% endif %}
            
            <!-- Settings -->
            {% if user|has_permission:'view_term' or user|has_permission:'view_grade' or user|has_permission:'view_class' %}
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'settings_list' or request.resolver_match.url_name == 'term_list' or request.resolver_match.url_name == 'grade_list' or request.resolver_match.url_name == 'class_list' or request.resolver_match.url_name == 'transport_route_list' %}active{% endif %}" 
                   href="#" data-bs-toggle="collapse" data-bs-target="#settingsSubmenu" aria-expanded="false">
                    <i class="fas fa-cog me-2"></i>
                    <span>Settings</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <ul class="collapse nav flex-column submenu" id="settingsSubmenu">
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'settings_list' %}active{% endif %}" href="{% url 'core:settings_list' %}">
                            <i class="fas fa-cog me-2"></i>Settings Overview
                        </a>
                    </li>
                    {% if user|has_permission:'view_term' or user|has_permission:'view_grade' or user|has_permission:'view_class' %}
                    <li class="nav-item"><hr class="dropdown-divider my-2"></li>
                    {% endif %}
                    {% if user|has_permission:'view_term' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'term_list' or request.resolver_match.url_name == 'term_create' or request.resolver_match.url_name == 'term_edit' %}active{% endif %}" href="{% url 'core:term_list' %}">
                            <i class="fas fa-calendar-alt me-2"></i>Terms
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_grade' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'grade_list' or request.resolver_match.url_name == 'grade_create' or request.resolver_match.url_name == 'grade_edit' %}active{% endif %}" href="{% url 'core:grade_list' %}">
                            <i class="fas fa-graduation-cap me-2"></i>Grades
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_class' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'class_list' or request.resolver_match.url_name == 'class_create' or request.resolver_match.url_name == 'class_edit' %}active{% endif %}" href="{% url 'core:class_list' %}">
                            <i class="fas fa-chalkboard me-2"></i>Classes
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_fee' %}
                    <li class="nav-item"><hr class="dropdown-divider my-2"></li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'transport_route_list' or request.resolver_match.url_name == 'transport_route_create' or request.resolver_match.url_name == 'transport_route_edit' %}active{% endif %}" href="{% url 'core:transport_route_list' %}">
                            <i class="fas fa-route me-2"></i>Transport Routes
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_user_management' or user|has_permission:'view_role_management' %}
                    <li class="nav-item"><hr class="dropdown-divider my-2"></li>
                    {% if user|has_permission:'view_user_management' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'user_list' or request.resolver_match.url_name == 'user_create' or request.resolver_match.url_name == 'user_edit' or request.resolver_match.url_name == 'profile' %}active{% endif %}" href="{% url 'core:user_list' %}">
                            <i class="fas fa-users me-2"></i>User Management
                        </a>
                    </li>
                    {% endif %}
                    {% if user|has_permission:'view_role_management' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'role_list' or request.resolver_match.url_name == 'role_create' or request.resolver_match.url_name == 'role_edit' %}active{% endif %}" href="{% url 'core:role_list' %}">
                            <i class="fas fa-user-tag me-2"></i>Role Management
                        </a>
                    </li>
                    {% endif %}
                    {% endif %}
                </ul>
            </li>
            
            {% if user|has_permission:'view_school_management' %}
            <!-- Super Admin: Manage Schools -->
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'school_admin_list' %}active{% endif %}" href="{% url 'core:school_admin_list' %}">
                    <i class="fas fa-school me-2"></i>
                    <span>Manage Schools</span>
                </a>
            </li>
            {% endif %}
        </ul>
        {% else %}
        {% comment %}User without school assignment - show only Manage Schools for superadmin, warning for others{% endcomment %}
        <ul class="nav flex-column">
            {% if user|has_permission:'view_school_management' %}
            <!-- Super Admin: Manage Schools (even without school assignment) -->
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'school_admin_list' %}active{% endif %}" href="{% url 'core:school_admin_list' %}">
                    <i class="fas fa-school me-2"></i>
                    <span>Manage Schools</span>
                </a>
            </li>
            {% else %}
            <li class="nav-item">
                <span class="nav-link text-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>You must be assigned to a school to access menus. Please contact administrator.
                </span>
            </li>
            {% endif %}
        </ul>
        {% endif %}
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endif %}
        
        {% if user|has_permission:'view_parent_portal' %}
        {% comment %}Parent Portal Menu - Standalone menu for parents{% endcomment %}
        <ul class="nav flex-column">
            <!-- Parent Portal Dashboard -->
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'parent_portal_dashboard' or 'parent_portal' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'core:parent_portal_dashboard' %}">
                    <i class="fas fa-home me-2"></i>
                    <span>Parent Portal</span>
                </a>
            </li>
            
            {% if user.profile and user.profile.is_parent %}
            <!-- My Profile (only for actual parents, not superusers) -->
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'parent_portal_profile' %}active{% endif %}" href="{% url 'core:parent_portal_profile' %}">
                    <i class="fas fa-user-edit me-2"></i>
                    <span>My Profile</span>
                </a>
            </li>
            {% endif %}
        </ul>
        {% endif %}
        {% endif %}
    </nav>
    
    <!-- User Profile Section -->
    {% if user.is_authenticated %}
    <div class="sidebar-footer">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link user-profile-link" href="#" data-bs-toggle="collapse" data-bs-target="#userProfileSubmenu" aria-expanded="false">
                    <i class="fas fa-user-circle me-2"></i>
                    <span>{{ user.username }}</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <ul class="collapse nav flex-column submenu" id="userProfileSubmenu">
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'profile' %}active{% endif %}" href="{% url 'core:profile' %}">
                            <i class="fas fa-user me-2"></i>Profile
                        </a>
                    </li>
                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">
                    <i class="fas fa-sign-out-alt me-2"></i>
                    <span>Logout</span>
                </a>
            </li>
            <form id="logout-form" method="post" action="{% url 'logout' %}" style="display: none;">
                {% csrf_token %}
            </form>
        </ul>
    </div>
    {% else %}
    <div class="sidebar-footer">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="{% url 'login' %}">
                    <i class="fas fa-sign-in-alt me-2"></i>
                    <span>Login</span>
                </a>
            </li>
        </ul>
    </div>
    {% endif %}
</aside>

<!-- Mobile Toggle Button -->
<button class="sidebar-toggle" id="sidebarToggle" type="button" aria-label="Toggle navigation menu">
    <i class="fas fa-bars"></i>
</button>

<!-- Overlay for mobile -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Mobile Sidebar Toggle - Simple, Immediate Script -->
<script>
(function() {
    // Simple mobile sidebar toggle - runs immediately
    function setupMobileSidebar() {
        var btn = document.getElementById('sidebarToggle');
        var sidebar = document.getElementById('sidebar');
        var overlay = document.getElementById('sidebarOverlay');
        
        if (!btn || !sidebar || !overlay) {
            // Retry if elements aren't ready yet
            setTimeout(setupMobileSidebar, 50);
            return;
        }
        
        // Flag to prevent overlay from closing sidebar immediately after opening
        var sidebarJustOpened = false;
        var touchHandled = false;
        
        // Simple toggle function
        function toggle() {
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                document.body.classList.remove('sidebar-open');
                sidebarJustOpened = false;
            } else {
                sidebar.classList.add('active');
                overlay.classList.add('active');
                document.body.classList.add('sidebar-open');
                sidebarJustOpened = true;
                // Reset flag after sidebar animation completes (prevents immediate closure)
                setTimeout(function() {
                    sidebarJustOpened = false;
                }, 400);
            }
        }
        
        // Make it globally available
        window.toggleMobileSidebar = toggle;
        
        // Direct event assignment - most reliable (as per hamburger fix5)
        btn.onclick = function(e) {
            e.preventDefault();
            // Prevent click if touch was already handled
            if (touchHandled) {
                touchHandled = false;
                return false;
            }
            toggle();
        };
        
        btn.ontouchstart = function(e) {
            e.preventDefault();
            touchHandled = true;
            toggle();
            // Reset touch flag after click would have fired
            setTimeout(function() {
                touchHandled = false;
            }, 300);
        };
        
        // Overlay close - prevent closing if sidebar just opened
        overlay.onclick = function(e) {
            if (sidebarJustOpened) {
                return;
            }
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.classList.remove('sidebar-open');
        };
        
        overlay.ontouchstart = function(e) {
            if (sidebarJustOpened) {
                return;
            }
            e.preventDefault();
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.classList.remove('sidebar-open');
        };
        
        // Show button on mobile
        if (window.innerWidth <= 767) {
            btn.style.display = 'flex';
        }
    }
    
    // Run immediately, don't wait for anything
    if (document.body) {
        setupMobileSidebar();
    } else {
        document.addEventListener('DOMContentLoaded', setupMobileSidebar);
    }
    // Also try immediately in case body exists
    setTimeout(setupMobileSidebar, 0);
})();
</script>

<script>
// Run immediately to prevent any collapse before page fully loads
(function() {
            // Expand submenus with active items immediately - use inline style as well
    const activeNavLinks = document.querySelectorAll('.sidebar-nav .submenu .nav-link.active');
    activeNavLinks.forEach(activeNavLink => {
        const parentSubmenu = activeNavLink.closest('.submenu');
        if (parentSubmenu) {
            // Add both collapse and show classes for Bootstrap, plus inline style
            parentSubmenu.classList.add('collapse', 'show');
            parentSubmenu.style.display = 'block'; // Force display
            const parentLink = parentSubmenu.previousElementSibling;
            if (parentLink && parentLink.classList.contains('nav-link')) {
                parentLink.classList.add('active');
                parentLink.setAttribute('aria-expanded', 'true');
                const icon = parentLink.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (icon) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                }
            }
        }
    });
    
    // Also handle parent links that are already active
    const activeParentLinks = document.querySelectorAll('.sidebar-nav > ul > .nav-item > .nav-link.active[data-bs-toggle="collapse"]');
    activeParentLinks.forEach(parentLink => {
        const targetId = parentLink.getAttribute('data-bs-target');
        if (targetId) {
            const target = document.querySelector(targetId);
            if (target) {
                target.classList.add('collapse', 'show');
                target.style.display = 'block';
                parentLink.setAttribute('aria-expanded', 'true');
            }
        }
    });
})();

document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    
    // Debug: Verify elements exist
    if (!sidebar) console.warn('Sidebar element not found');
    if (!sidebarToggle) console.warn('Sidebar toggle button not found');
    if (!sidebarOverlay) console.warn('Sidebar overlay not found');
    
    // Function to ensure active submenus stay expanded
    function ensureActiveSubmenusExpanded() {
        const activeNavLinks = document.querySelectorAll('.sidebar-nav .submenu .nav-link.active');
        activeNavLinks.forEach(activeNavLink => {
            const parentSubmenu = activeNavLink.closest('.submenu');
            if (parentSubmenu) {
                parentSubmenu.classList.add('collapse', 'show');
                parentSubmenu.style.display = 'block';
                const parentLink = parentSubmenu.previousElementSibling;
                if (parentLink && parentLink.classList.contains('nav-link')) {
                    parentLink.classList.add('active');
                    parentLink.setAttribute('aria-expanded', 'true');
                    const icon = parentLink.querySelector('.fa-chevron-down, .fa-chevron-up');
                    if (icon) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    }
                }
            }
        });
    }
    
    // Run immediately
    ensureActiveSubmenusExpanded();
    
    // Use MutationObserver to watch for class changes and re-apply if needed
    // Optimized with debouncing to prevent performance issues
    let mutationTimeout;
    const observer = new MutationObserver(function(mutations) {
        // Debounce to avoid excessive function calls
        clearTimeout(mutationTimeout);
        mutationTimeout = setTimeout(function() {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    const target = mutation.target;
                    if (target.classList.contains('submenu')) {
                        const hasActive = target.querySelector('.nav-link.active') !== null;
                        if (hasActive && !target.classList.contains('show')) {
                            target.classList.add('show');
                            target.style.display = 'block';
                        }
                    }
                }
            });
            ensureActiveSubmenusExpanded();
        }, 50); // Debounce by 50ms
    });
    
    // Observe all submenus - but only watch for class attribute changes
    const submenus = document.querySelectorAll('.sidebar-nav .submenu');
    if (submenus.length > 0) {
        submenus.forEach(submenu => {
            observer.observe(submenu, {
                attributes: true,
                attributeFilter: ['class'], // Only watch class changes
                childList: false, // Don't watch for child changes
                subtree: false // Don't watch subtree to improve performance
            });
        });
    }
    
    // ========================================
    // MOBILE SIDEBAR TOGGLE FUNCTIONALITY
    // ========================================
    // Note: Primary mobile sidebar toggle is handled in the immediate script above
    // This section only handles additional functionality like closing on menu item click
    
    // Function to close sidebar (used by menu item clicks)
    function closeSidebar() {
        if (sidebar) {
            sidebar.classList.remove('active');
            if (sidebarOverlay) {
                sidebarOverlay.classList.remove('active');
            }
            document.body.classList.remove('sidebar-open');
        }
    }
    
    // Ensure button is visible on mobile
    if (sidebarToggle) {
        function updateButtonVisibility() {
            if (window.innerWidth <= 767) {
                sidebarToggle.style.display = 'flex';
                sidebarToggle.style.visibility = 'visible';
                sidebarToggle.style.opacity = '1';
                sidebarToggle.style.pointerEvents = 'auto';
                sidebarToggle.style.zIndex = '1002';
            } else {
                sidebarToggle.style.display = 'none';
            }
        }
        
        // Set initial visibility
        updateButtonVisibility();
        window.addEventListener('resize', updateButtonVisibility);
    }
    
    // Close sidebar when clicking menu items (mobile only)
    // Uses event delegation for reliability - works even if menu items are loaded dynamically
    if (sidebar) {
        sidebar.addEventListener('click', function(e) {
            // Check if clicked element is a nav link (but not a collapse toggle)
            const clickedLink = e.target.closest('.nav-link:not([data-bs-toggle="collapse"])');
            if (clickedLink && window.innerWidth <= 767) {
                // Small delay to allow navigation to start
                setTimeout(function() {
                    closeSidebar();
                }, 100);
            }
        });
    }
    
    // Handle window resize - ensure sidebar is closed on mobile when resizing
    window.addEventListener('resize', function() {
        if (window.innerWidth > 767 && sidebar) {
            // Desktop view - ensure sidebar is visible
            sidebar.classList.remove('active');
            if (sidebarOverlay) {
                sidebarOverlay.classList.remove('active');
            }
            document.body.classList.remove('sidebar-open');
        }
    });
    
    // Function to expand submenu and mark parent as active
    function expandSubmenu(submenu, parentLink, forceExpand = false) {
        if (submenu && parentLink) {
            // Ensure collapse class is present for Bootstrap
            submenu.classList.add('collapse');
            submenu.classList.add('show');
            submenu.style.display = 'block'; // Force display with inline style
            parentLink.classList.add('active');
            parentLink.setAttribute('aria-expanded', 'true');
            
            const icon = parentLink.querySelector('.fa-chevron-down, .fa-chevron-up');
            if (icon) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
            
            // Initialize or get Bootstrap Collapse instance and show it
            if (typeof bootstrap !== 'undefined' && bootstrap.Collapse) {
                try {
                    let bsCollapse = bootstrap.Collapse.getInstance(submenu);
                    if (!bsCollapse) {
                        bsCollapse = new bootstrap.Collapse(submenu, {
                            toggle: false
                        });
                    }
                    // Force show - this ensures Bootstrap knows it should be shown
                    if (forceExpand || submenu.querySelector('.nav-link.active')) {
                        bsCollapse.show();
                    }
                } catch(e) {
                    // Fallback: just use classes and inline styles
                }
            }
        }
    }
    
    // Auto-expand active submenu and mark parent as active - run this after a small delay to ensure Bootstrap is initialized
    setTimeout(function() {
        const activeNavLinks = document.querySelectorAll('.sidebar-nav .submenu .nav-link.active');
        activeNavLinks.forEach(activeNavLink => {
            const parentSubmenu = activeNavLink.closest('.submenu');
            if (parentSubmenu) {
                const parentLink = parentSubmenu.previousElementSibling;
                if (parentLink && parentLink.classList.contains('nav-link')) {
                    expandSubmenu(parentSubmenu, parentLink, true);
                }
            }
        });
        
        // Also expand submenus when parent menu items are already marked as active
        const activeParentLinks = document.querySelectorAll('.sidebar-nav > ul > .nav-item > .nav-link.active[data-bs-toggle="collapse"]');
        activeParentLinks.forEach(parentLink => {
            const targetId = parentLink.getAttribute('data-bs-target');
            const target = document.querySelector(targetId);
            if (target) {
                expandSubmenu(target, parentLink, true);
            }
        });
    }, 50); // Small delay to ensure DOM and Bootstrap are ready
    
    // Prevent submenu links from triggering collapse - stop event propagation
    const submenuLinks = document.querySelectorAll('.sidebar-nav .submenu .nav-link');
    submenuLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            // Stop event propagation to parent collapse toggles
            e.stopPropagation();
            // Ensure parent submenu stays expanded
            const parentSubmenu = this.closest('.submenu');
            if (parentSubmenu) {
                parentSubmenu.classList.add('show');
                const parentLink = parentSubmenu.previousElementSibling;
                if (parentLink) {
                    parentLink.setAttribute('aria-expanded', 'true');
                }
            }
        });
    });
    
    // Handle submenu collapse/expand (only for toggle buttons, not submenu links)
    const submenuToggles = document.querySelectorAll('.sidebar-nav > ul > .nav-item > .nav-link[data-bs-toggle="collapse"]');
    submenuToggles.forEach(toggle => {
        const targetId = toggle.getAttribute('data-bs-target');
        const target = document.querySelector(targetId);
        const icon = toggle.querySelector('.fa-chevron-down, .fa-chevron-up');
        
        if (target) {
            // Check if this submenu has active items - if so, ensure it's expanded
            const hasActiveItem = target.querySelector('.nav-link.active') !== null;
            if (hasActiveItem) {
                target.classList.add('collapse', 'show');
                target.style.display = 'block';
                toggle.setAttribute('aria-expanded', 'true');
                if (icon) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                }
                // Use Bootstrap to show it properly
                if (typeof bootstrap !== 'undefined' && bootstrap.Collapse) {
                    try {
                        let bsCollapse = bootstrap.Collapse.getInstance(target);
                        if (!bsCollapse) {
                            bsCollapse = new bootstrap.Collapse(target, { toggle: false });
                        }
                        bsCollapse.show();
                    } catch(e) {}
                }
            }
            
            // Set up event listeners once
            target.addEventListener('shown.bs.collapse', function() {
                if (icon) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                }
            });
            
            // Prevent collapse if submenu contains active items - this is critical
            target.addEventListener('hide.bs.collapse', function(e) {
                const hasActive = target.querySelector('.nav-link.active') !== null;
                if (hasActive) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    e.stopPropagation();
                    // Force display to stay and restore classes
                    target.style.display = 'block';
                    target.classList.add('collapse', 'show');
                    toggle.setAttribute('aria-expanded', 'true');
                    // Try to show via Bootstrap instance
                    if (typeof bootstrap !== 'undefined' && bootstrap.Collapse) {
                        try {
                            let bsCollapse = bootstrap.Collapse.getInstance(target);
                            if (bsCollapse) {
                                bsCollapse.show();
                            }
                        } catch(err) {}
                    }
                    return false;
                }
            }, true); // Use capture phase to catch early
            
            target.addEventListener('hidden.bs.collapse', function() {
                // Only update icon if no active items
                const hasActive = target.querySelector('.nav-link.active') !== null;
                if (!hasActive && icon) {
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                } else if (hasActive) {
                    // If it somehow got hidden but has active, restore it
                    target.classList.add('collapse', 'show');
                    target.style.display = 'block';
                    toggle.setAttribute('aria-expanded', 'true');
                }
            });
            
            // Intercept toggle click to prevent collapse when active items exist
            toggle.addEventListener('click', function(e) {
                const hasActive = target.querySelector('.nav-link.active') !== null;
                // If submenu is currently shown and has active item, prevent toggle (collapse)
                if (target.classList.contains('show') && hasActive) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    // Ensure it stays open
                    target.classList.add('collapse', 'show');
                    target.style.display = 'block';
                    toggle.setAttribute('aria-expanded', 'true');
                    return false;
                }
            }, true); // Use capture phase to intercept before Bootstrap handles it
        }
    });
    
    // User profile submenu is now handled the same way as other nav items with submenus
    // No special initialization needed - it uses Bootstrap collapse like other submenus
}); // Close DOMContentLoaded event listener
</script>
