{% load static %}
{% load permissions %}

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        {% if user.is_authenticated and user.profile.school and user.profile.school.logo %}
            <div class="school-logo-container" style="display: inline-block; background-color: #ffffff; padding: 4px 8px; border-radius: 4px; margin-right: 10px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                <img src="{{ user.profile.school.logo.url }}" alt="School Logo" style="max-height: 32px; display: block;">
            </div>
        {% endif %}
        <a class="navbar-brand" href="{% url 'core:dashboard' %}">
            {% if user.is_authenticated and user.profile.school %}
                {{ user.profile.school.name|title }}
            {% else %}
                School Management System
            {% endif %}
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
            {% if user.is_authenticated and not user.profile.is_student and not user.profile.is_parent %}
            <ul class="navbar-nav">
                <!-- Dashboard -->
                <li class="nav-item">
                    <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" href="{% url 'core:dashboard' %}">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </a>
                </li>
                
                <!-- Students (MVP Module 2: Student Registration and Profile) -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle {% if request.resolver_match.url_name == 'student_list' or request.resolver_match.url_name == 'student_detail' or request.resolver_match.url_name == 'student_create' or request.resolver_match.url_name == 'student_update' %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-users me-2"></i>Students
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'core:student_list' %}">
                            <i class="fas fa-list me-2"></i>Student List
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'core:student_create' %}">
                            <i class="fas fa-plus me-2"></i>Add Student
                        </a></li>
                    </ul>
                </li>
                
                <!-- Teachers -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle {% if request.resolver_match.url_name == 'teacher_list' or request.resolver_match.url_name == 'teacher_add' or request.resolver_match.url_name == 'teacher_edit' or request.resolver_match.url_name == 'teacher_detail' %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user-tie me-2"></i>Teachers
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'core:teacher_list' %}">
                            <i class="fas fa-list me-2"></i>Teacher List
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'core:teacher_add' %}">
                            <i class="fas fa-plus me-2"></i>Add Teacher
                        </a></li>
                    </ul>
                </li>
                
                <!-- Fees Management (MVP Module 3: Fees Management) -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle {% if 'payments' in request.resolver_match.namespace or request.resolver_match.url_name == 'fee_structure_list' or request.resolver_match.url_name == 'generate_student_fees' %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-money-bill-wave me-2"></i>Fees
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'core:fee_structure_list' %}">
                            <i class="fas fa-list-alt me-2"></i>Fee Structures
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'core:generate_student_fees' %}">
                            <i class="fas fa-cogs me-2"></i>Generate Fees
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'payments:fee_summary' %}">
                            <i class="fas fa-file-invoice-dollar me-2"></i>Fee Summary
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{% url 'payments:payment_list' %}">
                            <i class="fas fa-credit-card me-2"></i>Payments
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'payments:receipt_list' %}">
                            <i class="fas fa-receipt me-2"></i>Receipts
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'payments:reminder_list' %}">
                            <i class="fas fa-bell me-2"></i>Reminders
                        </a></li>
                    </ul>
                </li>
                
                <!-- Attendance Management (MVP Module 4: Attendance Management) -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle {% if 'attendance' in request.resolver_match.namespace %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-check-circle me-2"></i>Attendance
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'attendance:attendance_list' %}">
                            <i class="fas fa-list me-2"></i>Attendance Records
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'attendance:mark_attendance' %}">
                            <i class="fas fa-edit me-2"></i>Mark Attendance
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'attendance:attendance_summary' %}">
                            <i class="fas fa-chart-bar me-2"></i>Summary
                        </a></li>
                    </ul>
                </li>
                
                <!-- Subjects -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle {% if request.resolver_match.url_name == 'subject_list' or request.resolver_match.url_name == 'subject_add' %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-book-open me-2"></i>Subjects
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'timetable:subject_list' %}">
                            <i class="fas fa-list me-2"></i>Subject List
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'timetable:subject_add' %}">
                            <i class="fas fa-plus me-2"></i>Add Subject
                        </a></li>
                    </ul>
                </li>
                
                <!-- Timetable Management (MVP Module 5: Time Table Management) -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle {% if 'timetable' in request.resolver_match.namespace and request.resolver_match.url_name != 'subject_list' and request.resolver_match.url_name != 'subject_add' %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-calendar-week me-2"></i>Timetable
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'timetable:timetable_list' %}">
                            <i class="fas fa-calendar me-2"></i>Class Timetables
                        </a></li>
                    </ul>
                </li>
                
                <!-- Exams & Gradebook (MVP Module 6: Exam and Gradebook) -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle {% if 'exams' in request.resolver_match.namespace %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-clipboard-list me-2"></i>Exams
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'exams:exam_list' %}">
                            <i class="fas fa-file-alt me-2"></i>Exams
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'exams:gradebook_list' %}">
                            <i class="fas fa-book me-2"></i>Gradebook
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'exams:gradebook_summary_list' %}">
                            <i class="fas fa-chart-bar me-2"></i>Summary
                        </a></li>
                    </ul>
                </li>
                
                <!-- Homework/Assignments (MVP Module 7: Homework/Assignment) -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle {% if 'homework' in request.resolver_match.namespace %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-book me-2"></i>Homework
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'homework:assignment_list' %}">
                            <i class="fas fa-list me-2"></i>Assignments
                        </a></li>
                        {% if user.profile.is_school_admin or user.profile.is_teacher %}
                        <li><a class="dropdown-item" href="{% url 'homework:submission_list' %}">
                            <i class="fas fa-check-circle me-2"></i>View Submissions
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                
                <!-- Communications (MVP Module 7: Communication and Notifications) -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle {% if 'communications' in request.resolver_match.namespace %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-envelope me-2"></i>Communications
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'communications:dashboard' %}">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{% url 'communications:template_list' %}">
                            <i class="fas fa-file-alt me-2"></i>Templates
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'communications:email_list' %}">
                            <i class="fas fa-envelope me-2"></i>Emails
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'communications:sms_list' %}">
                            <i class="fas fa-sms me-2"></i>SMS Messages
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'communications:log_list' %}">
                            <i class="fas fa-list me-2"></i>Communication Logs
                        </a></li>
                    </ul>
                </li>
                
                <!-- Reports -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle {% if request.resolver_match.url_name == 'financial_reports' or request.resolver_match.url_name == 'payment_collection_report' or request.resolver_match.url_name == 'outstanding_fees_report' or request.resolver_match.url_name == 'collection_summary_report' or request.resolver_match.url_name == 'payment_method_analysis' %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-chart-line me-2"></i>Reports
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'payments:financial_reports' %}">
                            <i class="fas fa-file-invoice-dollar me-2"></i>Financial Reports
                        </a></li>
                    </ul>
                </li>
                
                <!-- Settings/Configuration -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle {% if request.resolver_match.url_name == 'term_list' or request.resolver_match.url_name == 'grade_list' or request.resolver_match.url_name == 'class_list' or request.resolver_match.url_name == 'user_list' or request.resolver_match.url_name == 'role_list' %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-cog me-2"></i>Settings
                    </a>
                    <ul class="dropdown-menu">
                        {% if user|has_permission:'view_term' %}
                        <li><a class="dropdown-item" href="{% url 'core:term_list' %}">
                            <i class="fas fa-calendar-alt me-2"></i>Terms
                        </a></li>
                        {% endif %}
                        {% if user|has_permission:'view_grade' %}
                        <li><a class="dropdown-item" href="{% url 'core:grade_list' %}">
                            <i class="fas fa-graduation-cap me-2"></i>Grades
                        </a></li>
                        {% endif %}
                        {% if user|has_permission:'view_class' %}
                        <li><a class="dropdown-item" href="{% url 'core:class_list' %}">
                            <i class="fas fa-chalkboard me-2"></i>Classes
                        </a></li>
                        {% endif %}
                        {% if user.is_superuser or user.profile.is_school_admin %}
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{% url 'core:user_list' %}">
                            <i class="fas fa-users me-2"></i>User Management
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'core:role_list' %}">
                            <i class="fas fa-user-tag me-2"></i>Role Management
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                
                {% if user.is_superuser %}
                <!-- Super Admin: Manage Schools -->
                <li class="nav-item">
                    <a class="nav-link {% if request.resolver_match.url_name == 'school_admin_list' %}active{% endif %}" href="{% url 'core:school_admin_list' %}">
                        <i class="fas fa-school me-2"></i>Manage Schools
                    </a>
                </li>
                {% endif %}
            </ul>
            {% else %}
            <ul class="navbar-nav">
                <li class="nav-item">
                    <span class="nav-link text-warning">
                        <i class="fas fa-info-circle me-2"></i>Student/Parent features coming soon
                    </span>
                </li>
            </ul>
            {% endif %}
        </div>
        <ul class="navbar-nav ms-auto">
            {% if user.is_authenticated %}
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-user-circle"></i> {{ user.username }}
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#">Profile</a></li>
                    <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">Logout</a></li>
                </ul>
                <form id="logout-form" method="post" action="{% url 'logout' %}" style="display: none;">
                    {% csrf_token %}
                </form>
            </li>
            {% else %}
            <li class="nav-item">
                <a class="nav-link" href="{% url 'login' %}"><i class="fas fa-sign-in-alt"></i> Login</a>
            </li>
            {% endif %}
        </ul>
    </div>
</nav>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
    var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
        return new bootstrap.Dropdown(dropdownToggleEl);
    });
});
</script>