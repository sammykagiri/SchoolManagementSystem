{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Bulk Email | Communications{% endblock %}

{% block extra_css %}
<style>
    .student-checkbox {
        cursor: pointer;
    }
    .student-row:hover {
        background-color: #f8f9fa;
    }
    
    /* Hide filter form until Select2 is initialized to prevent flicker */
    #filterForm {
        visibility: hidden;
    }
    #filterForm.select2-ready {
        visibility: visible;
    }
    
    /* Match working Select2 example styles for Bootstrap 5 theme */
    .select2-container--bootstrap-5 .select2-selection--multiple {
        background-color: white !important;
        border: 1px solid #aaa !important;
        border-radius: 4px !important;
        cursor: text !important;
        padding-bottom: 5px !important;
        padding-right: 5px !important;
        position: relative !important;
        box-sizing: border-box !important;
        display: block !important;
        min-height: 32px !important;
        user-select: none !important;
        -webkit-user-select: none !important;
    }
    
    .select2-container--bootstrap-5.select2-container--focus .select2-selection--multiple {
        border: solid black 1px !important;
        outline: 0 !important;
    }
    
    /* Remove empty line at bottom - make ul inline */
    .select2-container--bootstrap-5 .select2-selection--multiple ul.select2-selection__rendered {
        padding: 0 !important;
        margin: 0 !important;
        list-style: none !important;
        display: inline !important;
    }
    
    /* List items - inline-block to prevent line breaks with spacing between them */
    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__rendered li.select2-selection__choice {
        margin: 2px 5px 2px 0 !important;  /* Top and bottom margin for spacing, right margin between items */
        padding: 0 !important;
        display: inline-block !important;
        vertical-align: top !important;
    }
    
    /* Search field - inline to stay on same line */
    .select2-container--bootstrap-5 .select2-selection__search--inline,
    .select2-container--bootstrap-5 .select2-search--inline {
        margin: 0 !important;
        padding: 0 !important;
        display: inline !important;
    }
    
    .select2-container--bootstrap-5 .select2-search__field {
        margin: 0 !important;
        padding: 0 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title"><i class="fas fa-paper-plane me-2"></i>Bulk Email</h3>
                    <a href="{% url 'communications:dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
                <div class="card-body">
                    <!-- Filters -->
                    <form method="post" class="mb-4" id="filterForm">
                        {% csrf_token %}
                        <input type="hidden" name="filter_action" value="apply">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="grade" class="form-label">Filter by Grade</label>
                                <select class="form-select select2" id="grade" name="grade" multiple="multiple">
                                    {% for grade in grades %}
                                        <option value="{{ grade.id }}">{{ grade.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="class" class="form-label">Filter by Class</label>
                                <select class="form-select select2" id="class" name="class" multiple="multiple">
                                    {% for class in classes %}
                                        <option value="{{ class.id }}">{{ class.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="route" class="form-label">Filter by Transport Route</label>
                                <select class="form-select select2" id="route" name="route" multiple="multiple">
                                    {% for route in routes %}
                                        <option value="{{ route.id }}">{{ route.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label d-block">&nbsp;</label>
                                <div class="form-check form-switch d-flex align-items-center h-100 mb-2">
                                    <input class="form-check-input" type="checkbox" id="show_inactive">
                                    <label class="form-check-label ms-2" for="show_inactive">Show Inactive</label>
                                </div>
                                <input type="hidden" id="showInactiveHidden" name="show_inactive" value="false">
                                <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="clearFiltersBtn">
                                    <i class="fas fa-times"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                    </form>

                    <form method="post" id="bulkEmailForm">
                        {% csrf_token %}
                        
                        <!-- Template Selection -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="template" class="form-label">
                                        Use Template (Optional) 
                                        <i class="fas fa-info-circle text-primary" 
                                           data-bs-toggle="tooltip" 
                                           title="Select a template to load its content. You can still edit the content before sending."></i>
                                    </label>
                                    <select class="form-select" id="template" name="template">
                                        <option value="">-- Select a Template --</option>
                                        {% for template in templates %}
                                        <option value="{{ template.id }}">{{ template.name }} ({{ template.get_message_type_display }})</option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        <strong>Tip:</strong> Selecting a template will automatically load its subject and content.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Email Fields -->
                        <div class="mb-3">
                            <label for="subject" class="form-label">Email Subject <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="subject" name="subject" required>
                        </div>
                        <div class="mb-4">
                            <label for="content" class="form-label">Email Content <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="content" name="content" rows="8" required></textarea>
                            <div class="form-text">
                                Use placeholders: {student_name}, {parent_name}, {amount}, {due_date}, {school_name}
                            </div>
                        </div>

                        <!-- Student Selection -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Select Students <span class="text-muted">(<span id="selectedCount">0</span> selected)</span></h5>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="selectAll">
                                        <i class="fas fa-check-square me-1"></i>Select All
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAll">
                                        <i class="fas fa-square me-1"></i>Deselect All
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover table-sm">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th width="50">
                                                <input type="checkbox" id="selectAllCheckbox" class="form-check-input" checked>
                                            </th>
                                            <th>Student ID</th>
                                            <th>Name</th>
                                            <th>Grade</th>
                                            <th>Class</th>
                                            <th>Parent Email</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentsTableBody">
                                        {% include 'communications/partials/bulk_email_table.html' %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'communications:dashboard' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="sendBulkEmailBtn">
                                <i class="fas fa-paper-plane me-2"></i>Send Bulk Email (<span id="sendCount">0</span>)
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    let studentCheckboxes = document.querySelectorAll('.student-check');
    const selectAllBtn = document.getElementById('selectAll');
    const deselectAllBtn = document.getElementById('deselectAll');
    const selectedCountSpan = document.getElementById('selectedCount');
    const sendCountSpan = document.getElementById('sendCount');
    const sendBtn = document.getElementById('sendBulkEmailBtn');
    const templateSelect = document.getElementById('template');
    const subjectInput = document.getElementById('subject');
    const contentTextarea = document.getElementById('content');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Auto-filter functionality with AJAX
    const filterForm = document.getElementById('filterForm');
    const showInactiveCheckbox = document.getElementById('show_inactive');
    const showInactiveHidden = document.getElementById('showInactiveHidden');
    const studentsTableBody = document.getElementById('studentsTableBody');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    
    // Clear any selected values immediately using native DOM, before Select2 initialization
    // Do this synchronously to prevent any visible flicker
    const gradeSelect = document.getElementById('grade');
    const classSelect = document.getElementById('class');
    const routeSelect = document.getElementById('route');
    
    // Clear values immediately (synchronously)
    if (gradeSelect) {
        Array.from(gradeSelect.options).forEach(option => option.selected = false);
    }
    if (classSelect) {
        Array.from(classSelect.options).forEach(option => option.selected = false);
    }
    if (routeSelect) {
        Array.from(routeSelect.options).forEach(option => option.selected = false);
    }
    if (showInactiveCheckbox) {
        showInactiveCheckbox.checked = false;
    }
    if (showInactiveHidden) {
        showInactiveHidden.value = 'false';
    }
    
    // Initialize Select2 immediately after clearing
    $('#grade').select2({
        theme: 'bootstrap-5',
        placeholder: 'All Grades',
        allowClear: true,
        width: '100%'
    });
    
    $('#class').select2({
        theme: 'bootstrap-5',
        placeholder: 'All Classes',
        allowClear: true,
        width: '100%'
    });
    
    $('#route').select2({
        theme: 'bootstrap-5',
        placeholder: 'All Transport Routes',
        allowClear: true,
        width: '100%'
    });
    
    // Mark filter form as ready to show Select2 elements
    // Use setTimeout to ensure Select2 has fully rendered
    setTimeout(function() {
        if (filterForm) {
            filterForm.classList.add('select2-ready');
        }
    }, 0);
    
    // Function to apply filters via AJAX
    const applyFilters = async () => {
        if (!filterForm) return;
        
        // Update show_inactive hidden input
        if (showInactiveCheckbox && showInactiveHidden) {
            showInactiveHidden.value = showInactiveCheckbox.checked ? 'true' : 'false';
        }
        
        // Get form data
        const formData = new FormData(filterForm);
        
        // Ensure filter_action is set (in case it's missing from form)
        if (!formData.has('filter_action')) {
            formData.append('filter_action', 'apply');
        }
        
        // Get CSRF token from the filter form or cookies
        let csrfToken = null;
        const csrfInput = filterForm.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            csrfToken = csrfInput.value;
        } else {
            // Fallback: get from cookies (Django's default CSRF cookie name)
            const name = 'csrftoken';
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [key, value] = cookie.trim().split('=');
                if (key === name) {
                    csrfToken = value;
                    break;
                }
            }
        }
        
        try {
            // Show loading state
            studentsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</td></tr>';
            
            // Send AJAX request
            const headers = {
                'X-Requested-With': 'XMLHttpRequest',
            };
            
            // Add CSRF token to header if available
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            
            const response = await fetch(window.location.href, {
                method: 'POST',
                headers: headers,
                body: formData,
                credentials: 'same-origin'  // Include cookies for CSRF
            });
            
            if (!response.ok) {
                // Try to get error details
                let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorData.message || errorMessage;
                } catch (e) {
                    const errorText = await response.text();
                    if (errorText) {
                        errorMessage += ` - ${errorText.substring(0, 100)}`;
                    }
                }
                throw new Error(errorMessage);
            }
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Non-JSON response received:', text.substring(0, 200));
                throw new Error('Server returned HTML instead of JSON. This might be a redirect or error page.');
            }
            
            const data = await response.json();
            
            // Check for error in response
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Update table body
            if (data.table_html) {
                studentsTableBody.innerHTML = data.table_html;
                
                // Re-initialize checkboxes and update counts
                const newCheckboxes = document.querySelectorAll('.student-check');
                newCheckboxes.forEach(cb => {
                    cb.addEventListener('change', function() {
                        if (selectAllCheckbox) {
                            selectAllCheckbox.checked = Array.from(newCheckboxes).every(c => c.checked);
                        }
                        updateSelectedCount();
                    });
                });
                
                // Update global studentCheckboxes reference
                studentCheckboxes = newCheckboxes;
                
                // Re-run deduplication and update counts
                deduplicateEmails();
                updateSelectedCount();
                
                // Re-initialize select all checkbox
                const newSelectAllCheckbox = document.getElementById('selectAllCheckbox');
                if (newSelectAllCheckbox) {
                    newSelectAllCheckbox.addEventListener('change', function() {
                        newCheckboxes.forEach(cb => {
                            cb.checked = this.checked;
                        });
                        updateSelectedCount();
                    });
                }
            }
        } catch (error) {
            console.error('Error applying filters:', error);
            studentsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger py-4">Error loading students. Please try again.</td></tr>';
        }
    };
    
    // Auto-apply filters on grade change
    $('#grade').on('change', applyFilters);
    
    // Auto-apply filters on class change
    $('#class').on('change', applyFilters);
    
    // Auto-apply filters on route change
    $('#route').on('change', applyFilters);
    
    // Auto-apply filters on show inactive checkbox change
    if (showInactiveCheckbox && showInactiveHidden) {
        showInactiveCheckbox.addEventListener('change', function() {
            applyFilters();
        });
    }
    
    // Clear filters button
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            // Clear Select2 selections
            $('#grade').val(null).trigger('change');
            $('#class').val(null).trigger('change');
            $('#route').val(null).trigger('change');
            
            // Uncheck show inactive
            if (showInactiveCheckbox) {
                showInactiveCheckbox.checked = false;
            }
            
            // Clear session by submitting empty filters
            if (showInactiveHidden) {
                showInactiveHidden.value = 'false';
            }
            
            // Apply filters (will clear session)
            applyFilters();
        });
    }
    
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Update selected count and send count (distinct email addresses)
    function updateSelectedCount() {
        const selected = document.querySelectorAll('.student-check:checked').length;
        const selectedCheckboxes = Array.from(studentCheckboxes).filter(cb => cb.checked);
        
        // Count distinct email addresses from selected students
        const distinctEmails = new Set();
        selectedCheckboxes.forEach(cb => {
            const row = cb.closest('tr');
            const emailCell = row.querySelector('.parent-email-cell');
            if (emailCell) {
                const emailSpans = emailCell.querySelectorAll('span[data-email]');
                emailSpans.forEach(span => {
                    const email = span.getAttribute('data-email');
                    if (email && email.trim()) {
                        distinctEmails.add(email.trim());
                    }
                });
            }
        });
        
        const distinctEmailCount = distinctEmails.size;
        
        selectedCountSpan.textContent = selected;
        sendCountSpan.textContent = distinctEmailCount;
        
        // Disable send button if no students selected or no email field or no distinct emails
        sendBtn.disabled = selected === 0 || !subjectInput.value.trim() || !contentTextarea.value.trim() || distinctEmailCount === 0;
    }
    
    // Select all checkbox
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            studentCheckboxes.forEach(cb => {
                cb.checked = this.checked;
            });
            updateSelectedCount();
        });
    }
    
    // Select all button
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', function() {
            studentCheckboxes.forEach(cb => {
                const row = cb.closest('tr');
                const emailCell = row.querySelector('td:last-child');
                // Only select students with email
                if (emailCell && !emailCell.textContent.includes('No email')) {
                    cb.checked = true;
                }
            });
            selectAllCheckbox.checked = Array.from(studentCheckboxes).every(cb => cb.checked);
            updateSelectedCount();
        });
    }
    
    // Deselect all button
    if (deselectAllBtn) {
        deselectAllBtn.addEventListener('click', function() {
            studentCheckboxes.forEach(cb => cb.checked = false);
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            updateSelectedCount();
        });
    }
    
    // Individual checkbox change
    studentCheckboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = Array.from(studentCheckboxes).every(c => c.checked);
            }
            updateSelectedCount();
        });
    });
    
    // Update count when subject/content changes
    subjectInput.addEventListener('input', updateSelectedCount);
    contentTextarea.addEventListener('input', updateSelectedCount);
    
    // Template loading
    templateSelect.addEventListener('change', function() {
        const templateId = this.value;
        
        if (!templateId) return;
        
        // Show loading state
        const originalSelectText = this.options[this.selectedIndex].text;
        this.disabled = true;
        this.options[this.selectedIndex].text = 'Loading template...';
        
        // Fetch template content via AJAX
        fetch(`{% url 'communications:get_template_content' 0 %}`.replace('0', templateId), {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.subject) subjectInput.value = data.subject;
                if (data.content) contentTextarea.value = data.content;
                updateSelectedCount();
            } else {
                alert('Error loading template: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load template. Please try again.');
        })
        .finally(() => {
            this.disabled = false;
            if (this.options[this.selectedIndex]) {
                this.options[this.selectedIndex].text = originalSelectText;
            }
        });
    });
    
    // Initial count update
    updateSelectedCount();
    
    // Function to deduplicate emails and handle empty cells
    function deduplicateEmails() {
        document.querySelectorAll('.parent-email-cell').forEach(cell => {
            const emailSpans = Array.from(cell.querySelectorAll('span[data-email]'));
            const seenEmails = new Set();
            const uniqueEmails = [];
            
            emailSpans.forEach(span => {
                const email = span.getAttribute('data-email');
                if (email && !seenEmails.has(email)) {
                    seenEmails.add(email);
                    uniqueEmails.push(span);
                } else if (email && seenEmails.has(email)) {
                    // Remove duplicate and any trailing comma/space
                    const nextSibling = span.nextSibling;
                    if (nextSibling && nextSibling.nodeType === Node.TEXT_NODE && nextSibling.textContent.trim() === ',') {
                        nextSibling.remove();
                    }
                    span.remove();
                }
            });
            
            // Clean up and update commas between remaining emails
            cell.innerHTML = ''; // Clear cell
            uniqueEmails.forEach((span, index) => {
                cell.appendChild(span);
                if (index < uniqueEmails.length - 1) {
                    cell.appendChild(document.createTextNode(', '));
                }
            });
            
            // Check if cell is empty and add "No email" if needed
            if (!cell.textContent.trim() || cell.textContent.trim() === '') {
                const noEmailSpan = document.createElement('span');
                noEmailSpan.className = 'text-danger';
                noEmailSpan.textContent = 'No email';
                cell.appendChild(noEmailSpan);
            }
        });
    }
    
    // Initial deduplication and count update
    deduplicateEmails();
    updateSelectedCount();
    
    // Update select all checkbox state based on current selections
    if (selectAllCheckbox) {
        const allChecked = Array.from(studentCheckboxes).every(cb => cb.checked);
        selectAllCheckbox.checked = allChecked;
    }
});
</script>
{% endblock %}
